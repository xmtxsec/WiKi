
# 僵尸扫描

**僵尸主机：**僵尸主机是指感染僵尸程序病毒，从而被黑客程序控制的计算机设备。但是僵尸扫描中的僵尸主机指得是一个闲置的操作系统(这里的闲置是指主机不会主动和任何人通信) ，系统中IP数据包中ID是递增的。比如: XP系统。


# 工作流程

1、攻击者向僵尸机发送SYN/ACK确认包。僵尸主机返回我们RST数据包关闭链接，RST数据包中包含了IPID信息。假设IPID=X。<br />注：三次握手的第一个包是 SYN ,目标主机收到SYN才会应答SYN/ACK ,因为僵尸主机没有向我们发送SYN请求。所以僵尸主机返回我们RST数据包关闭链接。第一步中,黑客的收获是:知道了僵尸主机的IPID。

2、攻击者修改IP包头的SRC字段为僵尸主机的IP ,伪装成僵尸主机给目标主机发SYN请求。目标主机收到请求，如果端口是开放的就会返回给僵尸主机一个SYN/ACK的数据包。僵尸主机收到目标主机发来的SYN/ACK确认包,因为僵尸主机没有给你发SYN请求。所以僵尸主机给目标主机返回了一个RST数据包。这个数据包表示关闭连接。此僵尸主机对外发出一个数据包,所以僵尸主机的IPID值+1。此时IPID值为X+1。

3、攻击者再次向僵尸主机发送SYN/ACK确认包，僵尸主机同样向攻击者返回了一个RST数据包,此僵尸主机对外又发出一个数据包,所以僵尸主机的IPID值再+1。此时IPID值为X+2。

4、计算3次通信过中的IPID值。攻击者查看僵尸主机返回的数据包中IPID值为X+2、攻击者对比在第一步中的IPID值X ,发现增加了2。结论:肯定目标主机和僵尸主机通信了,能通信,就说明目标主机端口是开放的。


# 实验


## 环境准备
攻击机：192.168.1.37<br />僵尸机：192.168.1.5<br />目标机：192.168.1.15<br />使用工具：scapy


## 当端口为关闭的情况
1、打开scapy给僵尸主机发送的SYN/ACK数据包,将返回的数据包存入dp1
```
dp1=sr1(IP(dst="192.168.1.5")/TCP(dport= 445,flags="SA"))

命令详解:
dp1表示定义了一个变量来接受我们返回的数据包
dst表示我们的僵尸主机IP
dport=445表示我们向僵F主机的445端口发送数据包, XP主机的445端口一般都是开启状态
flags=“SA" 表示发送SYN/ACK
```
![image-20211025093153803.png](_img/assets/1652239053773-4c4ff1a2-c55c-4d5a-95c2-7d427ace627e.png)


2、修改IP包头的SRC字段为僵尸主机的IP ,伪装成僵尸主机给目标主机发SYN请求。
```
rt=sr1(IP(src ="192.168.1.5",dst="192.168.1.15")/TCP(dport=80),timeout=1)

命令详解：
rt表示定义了一个变量来接受我们返回的数据包
src表示伪造成僵F主机的IP地址
dst表示将数据包发送目标主机
dport目标端口
timeout超时时间
```
![image-20211025093239618.png](_img/assets/1652239060401-02527c84-b832-4285-a393-f6a7ebbf6461.png)

3、再次向僵尸主机发送SYN/ACK确认包,获得IPID
```
dp2=sr1(IP(dst="192.168.1.5")/TCP(dport=445,flags="SA"))
```
![image-20211025093823856.png](_img/assets/1652239063543-fb59104a-629a-493e-bd5e-2674bbcd2fa1.png)

4、实验结果查看<br />display()表示查看变量中的内容。我们只需要查看IP下面的ID字段即可。<br />查看dp1<br />![image-20211025093914904.png](_img/assets/1652239066795-5685b740-bcf8-4f8c-a3fb-a84cda9624b4.png)

查看dp2<br />![image-20211025093938816.png](_img/assets/1652239070174-99222b5b-eefe-4ff4-9ed4-debeb73ddc35.png)

我们可以看到1159、1161结果为+2 即端口为开放状态


## 当端口为关闭的情况
```
步骤一：dp1=sr1(IP(dst="192.168.1.5")/TCP(dport= 445,flags="SA"))
步骤二：rt=sr1(IP(src ="192.168.1.5",dst="192.168.1.15")/TCP(dport=666),timeout=1)
步骤三：dp2=sr1(IP(dst="192.168.1.5")/TCP(dport=445,flags="SA"))
```
![image-20211025094259426.png](_img/assets/1652239073909-75422e45-5705-4b81-8911-425126b49bc7.png)


## <br />
查看dp1<br />![image-20211025094328608.png](_img/assets/1652239076889-f8237054-3e6d-413a-9031-63ab66bc95a3.png)

查看dp2<br />![image-20211025094355013.png](_img/assets/1652239080458-43800a28-642c-44fe-9fe6-2e54b998e30d.png)

我们可以看到1180、1181结果为+1 即端口为关闭状态
