# 一、网际协议 IP

网际协议IP是TCP/IP体系中两个最主要的协议之一，也是最重要的互联网标准协议之一。严格来说，这里所讲的IP其实是IP的第4个版本，应记为IPv4。但在讲述IP协议的各种原理时，往往不在IP后面加上版本号。

与IP协议配套使用的还有三个协议:

- 地址解析协议ARP (Address Resolution Protocol)
- 网际控制报文协议ICMP (Internet Control Message Protocol)
- 网际组管理协议IGMP (Internet Group Management Protocol)

![image-20230204214734983](https://cdn.jsdelivr.net/gh/xmtxsec/picture/img/image-20230204214734983.png)



从一般的概念来讲，将网络互相连接起来要使用一些中间设备。根据中间设备所在的层次，可以有以下四种不同的中间设备:

1. 物理层使用的中间设备叫做**转发器**(repeater)。
2. 数据链路层使用的中间设备叫做**网桥**或**桥接器**(bridge)。
3. 网络层使用的中间设备叫做**路由器**(router)”。
4. 在网络层以上使用的中间设备叫做**网关**(gateway)。



## 1.1、IP 地址

IP地址就是给互联网上的每一台主机(或路由器)的每一个接口分配一个在全世界范围内是唯一的32位的标识符。

IP地址的编址方法共经过了三个历史阶段。

1. 分类的IP地址。这是最基本的编址方法，在1981年就通过了相应的标准协议。
2. 子网的划分。这是对最基本的编址方法的改进，其标准RFC 950在1985年通过。
3. 构成超网。这是比较新的无分类编址方法。1993 年提出后很快就得到推广应用。



所谓“分类的IP地址”就是将IP地址划分为若干个固定类，每一类地址都由两个固定长度的字段组成，其中第一个字段是**网络号**，它标志主机(或路由器)所连接到的网络。一个网络号在整个互联网范围内必须是唯一的。第二个字段是**主机号**，它标志该主机(或路由器)。一台主机号在它前面的网络号所指明的网络范围内必须是唯一的。由此可见，一个IP地址在整个互联网范围内是唯一的。



![image-20230210110336384](https://cdn.jsdelivr.net/gh/xmtxsec/picture/img/202302101103147.png)

- A类、B类和C类地址的网络号字段(分别为1个、2个和3个字节长，而在网络号字段的最前面有1~3 位的类别位，其数值分别规定为
  0，10和110。
- A类、B类和C类地址的主机号字段分别为3个、2个和1个字节长。
- D类地址(前4位是1110)用于多播(一对多通信)。
- E类地址(前4位是1111)保留为以后用。



## 12、子网掩码

为了更便于查找路由表。现在互联网的标准规定：**所有的网络都必须使用子网掩码，同时在路由器的路由表中也必须有子网掩码**。如果一个网络不划分子网，那么该网络的子网掩码就使用默认子网掩码。默认子网掩码中1的位置和IP 地址中的网络号字段正好相对应。因此，若用默认子网掩码和IP地址逐位相“与”(AND)，就应当能够得出该IP地址的网络地址来。这样做可以不用查找该地址的类
别位就能知道这是哪一类的IP地址。

- A类地址的默认子网掩码是255.0.0.0，或0xFF000000。
- B类地址的默认子网掩码是255.255.0.0，或0xFFFF0000。
- C类地址的默认子网掩码是255.255.255.0，或0xFFFFF00。

![image-20230210114101485](https://cdn.jsdelivr.net/gh/xmtxsec/picture/img/202302101141549.png)





## 1.3、物理地址

从层次的角度看，物理地址是数据链路层和物理层使用的地址，而IP地址是网络层和以上各层使用的地址，是一种逻辑地址。

![image-20230210111027515](https://cdn.jsdelivr.net/gh/xmtxsec/picture/img/202302101110567.png)



在发送数据时，数据从高层下到低层，然后才到通信链路上传输。使用IP地址的IP数据报一旦交给了数据链路层，就被封装成MAC帧了。**MAC帧在传送时使用的源地址和目的地址都是硬件地址**，这两个硬件地址都写在MAC帧的首部中。连接在通信链路上的设备(主机或路由器)在收到MAC帧时，根据MAC帧首部中的硬件地址决定收下或丢弃。**只有在剥去MAC帧的首部和尾部后把MAC层的数据上交给网络层后，网络层才能在IP数据报的首部中找到源IP地址和目的IP地址。**

------



# 二、地址解析协议 ARP

**IP协议使用了ARP协议，因此通常就把ARP协议划归网络层。但ARP协议的用途是为了从网络层使用的IP地址，解析出在数据链路层使用的硬件地址。**因此，有的教科书就按照协议的所用，把ARP协议划归在数据链路层。还有一个旧的协议叫做逆地址解析协议RARP，它的作用是使只知道自己硬件地址的主机能够通过RARP协议找出其IP地址。现在的DHCP协议已经包含了RARP协议的功能。

![](https://cdn.jsdelivr.net/gh/xmtxsec/picture/img/202302101116679.png)



## 2.1、ARP协议工作原理

每一台主机都设有一个**ARP高速缓存(ARP cache)**，里面有本局域网上的各主机和路由器的IP地址到硬件地址的映射表，这些都是该主机目前知道的一些地址。并且这个映射表还经常动态更新(新增或超时删除)。

当主机A要向本局域网上的某台主机B发送IP数据报时，就先在其ARP高速缓存中查看有无主机B的IP地址。

如有，就在ARP高速缓存中查出其对应的硬件地址，再把这个硬件地址写入MAC帧，然后通过局域网把该MAC帧发往此硬件地址。

也有可能查不到主机B的IP地址的项目。这可能是主机B才入网，也可能是主机A刚刚加电，其高速缓存还是空的。在这种情况下，主机A就自动运行ARP, 然后按以下步骤找出主机B的硬件地址。



**同局域网下**

1. ARP进程在本局域网上广播发送一个ARP请求分组。ARP请求分组的主要内容是：`我的IP地址是209.0.0.5， 硬件地址是00-00-C0-15-AD-18。 我想知道IP地址为209.0.0.6的主机的硬件地址。`

![](https://cdn.jsdelivr.net/gh/xmtxsec/picture/img/202302101116850.png) 



2. 在本局域网上的所有主机上运行的ARP进程都收到此ARP请求分组。 
3. 主机B的IP地址与ARP请求分组中要查询的IP地址一致，就收下这个ARP请求分组，并向主机A发送ARP响应分组，同时在这个ARP响应分组中写入自己的硬件地址。由于其余的所有主机的IP地址都与ARP请求分组中要查询的IP地址不一致，因此都不理睬这个ARP请求分组。 ARP响应分组的主要内容是：`我的IP地址是209.0.0.6，我的硬件地址是08-00-2B-00-EE-0A。`虽然ARP请求分组是广播发送的，但ARP响应分组是普通的单播，即从一个源地址发送到一个目的地址。

![](https://img-blog.csdnimg.cn/6daa6a686d6a42a490776447b3c62d55.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5bCP6bij5ZCM5a2m4oSh,size_20,color_FFFFFF,t_70,g_se,x_16#crop=0&crop=0&crop=1&crop=1&id=HZf95&originHeight=211&originWidth=722&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=) 

4. 主机A收到主机B的ARP响应分组后，就在其ARP高速缓存中写入主机B的IP地址到硬件地址的映射。 



当主机A向B发送数据报时，很可能以后不久主机B还要向A发送数据报，因而主机B也可能要向A发送ARP请求分组。为了减少网络上的通信量，**主机A在发送其ARP请求分组时，就把自己的IP地址到硬件地址的映射写入ARP请求分组。当主机B收到A的ARP请求分组时，就把主机A的这一地址映射写入主机B自己的ARP高速缓存中。**



ARP对保存在高速缓存中的每一个映射地址项目都设置生存时间(例如，10~20分钟)。凡超过生存时间的项目就从高速缓存中删除掉。请注意，ARP是解决**同一个局域网**上的主机或路由器的IP地址和硬件地址的映射问题。



**不同局域网下**

![](https://cdn.jsdelivr.net/gh/xmtxsec/picture/img/202302101116673.png)

1.  主机H1发送给H2的IP数据报首先需要通过与主机H1连接在同一个局域网上的路由器R1来转发。因此主机H1这时需要把路由器R1的IP地址IP3解析为硬件地址HA3，以便能够把IP数据报传送到路由器R1。 
2.  R1从转发表找出了下一跳路由器R2,同时使用ARP解析出R2的硬件地址HA5。于是IP数据报按照硬件地址HA5转发到路由器R2。路由器R2在转发这个IP数据报时用类似方法解析出目的主机H2的硬件地址HA2,使IP数据报最终交付主机H2。 

**从IP地址到硬件地址的解析是自动进行的，主机的用户对这种地址解析过程是不知道的。只要主机或路由器要和本网络上的另一个已知IP地址的主机或路由器进行通信，ARP协议就会自动地把这个IP地址解析为链路层所需要的硬件地址。**




## 2.2、使用ARP协议的四种典型情况

![](https://img-blog.csdnimg.cn/960a129835fd4e8e8a2c037bdb144d6b.png#crop=0&crop=0&crop=1&crop=1&id=odEmn&originHeight=137&originWidth=693&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=)

1.  发送方是主机(如H)，要把IP数据报发送到同一个网络上的另一台主机(如H2)。这时H1发送ARP请求分组(在网1上广播)，找到目的主机H2的硬件地址。 
2.  发送方是主机(如H1)，要把IP数据报发送到另一个网络上的一台主机(如H3或H4)。这时H1发送ARP请求分组(在网1上广播)，找到网1上的一个路由器R1的硬件地址。剩下的工作由路由器R1来完成。R1 要做的事情是下面的3或4。 
3.  发送方是路由器(如R1),要把IP数据报转发到与R1连接在同一个网络(网2)上的主机(如H3)。这时R1发送ARP请求分组(在网2上广播)，找到目的主机H3的硬件地址。 
4.  发送方是路由器(如R1)，要把IP数据报转发到网3上的一台主机(如H4)。H4与R1不是连接在同一个网络上。这时R1发送ARP请求分组(在网2上广播)，找到连接在网2上的一个路由器R2的硬件地址。剩下的工作由这个路由器R2来完成。 

在许多情况下需要多次使用ARP。但这只是以上几种情况的反复使用而已。

------



# 三、网际控制报文协议 ICMP

**ICMP允许主机或路由器报告差错情况和提供有关异常情况的报告。**ICMP是互联网的标准协议。但ICMP不是高层协议(因为ICMP报文是装在IP数据报中，作为其中的数据部分)，而是IP层的协议。ICMP报文作为IP层数据报的数据，加上数据报的首部，组成IP数据报发送出去。

![](https://cdn.jsdelivr.net/gh/xmtxsec/picture/img/202302101339226.png)



## 3.1、ICMP 协议的种类

ICMP报文的种类有两种，即**ICMP差错报告报文**和**ICMP询问报文**。

![image-20230210134147041](https://cdn.jsdelivr.net/gh/xmtxsec/picture/img/202302101341202.png)

ICMP差错报告报文共有四种:

1.  终点不可达，当路由器或主机不能交付数据报时就向源点发送终点不可达报文。 
2.  时间超过，当路由器收到生存时间为零的数据报时，除丢弃该数据报外，还要向源点发送时间超过报文。当终点在预先规定的时间内不能收到一个数据报的全部数据报片时，就把己收到的数据报片都丢弃，并向源点发送时间超过报文。 
3.  参数问题，当路由器或目的主机收到的数据报的首部中有的字段的值不正确时，就丢弃该数据报，并向源点发送参数问题报文。 
4.  改变路由(重定向)，路由器把改变路由报文发送给主机，让主机知道下次应将数据报发送给另外的路由器(可通过更好的路由)。 



## 3.2、ICMP 数据字段内容

ICMP差错报告报文中的数据字段**都具有同样的格式**。

把收到的需要进行差错报告的IP数据报的首部和数据字段的前8个字节提取出来，作为ICMP报文的数据字段。再加上相应的ICMP差错报告报文的前8个字节，就构成了ICMP差错报告报文。

提取收到的数据报的数据字段前8个字节是为了得到运输层的端口号(对于TCP和UDP)以及运输层报文的发送序号(对于TCP)。这些信息对源点通知高层协议是有用的。整个ICMP报文作为IP 数据报的数据字段发送给源点。

![image-20230210135018916](https://cdn.jsdelivr.net/gh/xmtxsec/picture/img/202302101350980.png)



**不应发送ICMP差错报文的几种情况**

- 对ICMP差错报告报文，不再发送ICMP差错报告报文。
- 对第一个分片的数据报片的所有后续数据报片，都不发送ICMP差错报告报文。
- 对具有多播地址的数据报，都不发送ICMP差错报告报文。
- 有特殊地址(如127.0.0.0或0.0.0.0)的数据报，不发送ICMP差错报告报文。



**常用的两种ICMP询问报文**

1. **回送请求和回答**，ICMP回送请求报文是由主机或路由器向一个特定的目的主机发出的询问。收到此报文的主机必须给源主机或路由器发送ICMP回送回答报文。这种询问报文用来测试目的站是否可达以及了解其有关状态。
2. **请求和回答**，ICMP时间戳请求报文是请某台主机或路由器回答当前的日期和时间。在ICMP时间戳回答报文中有一个 32位的字段，其中写入的整数代表从1900年1月1日起到当前时刻一共有多少秒。时间戳请求与回答可用于时钟同步和时间测量。



## 3.3、ICMP 的应用

**Ping**

ICMP的一个重要应用就是**分组网间探测PING (Packet InterNet Groper)**，用来测试两台主机之间的连通性。PING使用了ICMP 回送请求与回送回答报文。PING是应用层直接使用网络层ICMP的一个例子。它没有通过运输层的TCP或UDP。



从武汉的一台PC到www.baidu.com 连通性的测试结果。PC一连发出四个ICMP回送请求报文。如果服务器正常工作而且响应这个ICMP回送请求报文(有的主机为了防止恶意攻击就不理睬外界发送过来的这种报文)，那么它就发回ICMP回送回答报文。由于往返的ICMP报文上都有时间戳，因此很容易得出往返时间。最后显示出的是统计结果：发送到哪个机器(IP 地址)，发送的、收到的和丢失的分组数(但不给出分组丢失的原因)，以及往返时间的最小值、最大值和平均值。

![image-20230210135356006](https://cdn.jsdelivr.net/gh/xmtxsec/picture/img/202302101353057.png)



**路由跟踪**

从源主机向目的主机发送一连串的IP数据报，数据报中封装的是无法交付的UDP用户数据报。

1. 第一个数据报P1的生存时间TTL设置为1。当P1到达路径上的第一个路由器R1时，路由器R1先收下它，接着把TTL的值减1。由于TTL等于零了，R1 就把P1丢弃了，并向源主机发送一个ICMP时间超过差错报告报文。
2. 源主机接着发送第二个数据报P2,并把TTL设置为2。P2先到达路由器R1，R1收下后把TTL减1再转发给路由器R2。R2收到P2时TTL为1，但减1后TTL变为零了。R2就丢弃P2,并向源主机发送一个ICMP时间超过差错报告报文。
3. 这样一直继续下去。当最后个数据报刚刚到达目的主机时，数据报的TTL是1。主机不转发数据报，也不把TTL值减1。但因IP数据报中封装的是无法交付的运输层的UDP用户数据报，因此目的主机要向源主机发送ICMP终点不可达差错报告报文。

这样，源主机达到了自己的目的，因为这些路由器和最后目的主机发来的ICMP报文正好给出了源主机想知道的路由信息,到达目的主机所经过的路由器的IP地址，以及到达其中的每一个路由器的往返时间。

![image-20230210135936502](https://cdn.jsdelivr.net/gh/xmtxsec/picture/img/202302101359548.png)











