
# 概述
文件下载功能在很多web系统上都会出现，一般我们当点击下载链接，便会向后台发送一个下载请求，一般这个请求会包含一个需要下载的文件名称，后台在收到请求后会开始执行下载代码，将该文件名对应的文件response给浏览器，从而完成下载。

如果后台在收到请求的文件名后,将其直接拼进下载文件的路径中而不对其进行安全判断的话，则可能会引发不安全的文件下载漏洞。此时如果 攻击者提交的不是一个程序预期的的文件名，而是一个精心构造的路径(比如../../../etc/passwd),则很有可能会直接将该指定的文件下载下来。从而导致后台敏感信息(密码文件、源代码等)被下载。

所以，在设计文件下载功能时，如果下载的目标文件是由前端传进来的，则一定要对传进来的文件进行安全考虑。切记：所有与前端交互的数据都是不安全的，不能掉以轻心！


# unsafe filedownload

## 查看关键源码
```php
// $file_name="cookie.jpg";
$file_path="download/{$_GET['filename']}";
//用以解决中文不能显示出来的问题
$file_path=iconv("utf-8","gb2312",$file_path);

//首先要判断给定的文件存在与否
if(!file_exists($file_path)){
    skip("你要下载的文件不存在，请重新下载", 'unsafe_down.php');
    return ;
}
```

通过代码我们可以看到将变量传进来直接包拼接,没做任何的安全限制。


## 函数说明
```
iconv()
例：
# 把gb2312置换成utf-8
$text=iconv("GB2312","UTF-8",$text);
```

```
file_exists() 函数检查文件或目录是否存在。如果指定的文件或目录存在则返回 TRUE，否则返回 FALSE。

语法
file_exists(path)
path	必需。规定要检查的路径。
```


## 实战
我们在新标签页中打开下载文件可以看到URL<br />![image-20210709143813212.png](./assets/1655881922239-c64c8e32-4d9c-4eac-968c-7faa9c2477a3.png)

尝试下载etc/passwd文件,输入
```
../../../../../../../../etc/passwd
```

成功<br />![image-20210709144107734.png](./assets/1655881930399-d0336907-d268-495a-9364-d009b9cba235.png)
