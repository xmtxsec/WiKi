<span style='font-size:17px'>

# 1、恶意代码概述

## 1.1、恶意代码定义与分类

恶意代码的英文是 Malicious Code，它是一种违背目标系统安全策略的程序代码，会造成目标系统信息泄露、资源滥用，破坏系统的完整性及可用性。它能够经过存储介质或网络进行传播，从一 台计算机系统传到另外一 台计算机系统，未经授权认证访问或破坏计算机系统。



恶意代码的种类主要包括计算机病毒(Computer Virus)、蠕虫(Worms) 、特洛伊木马(Trojan Horse)、逻辑炸弹 (Logic Bombs）、细菌 (Bacteria) 、恶意脚本(Malicious Scripts)和恶意ActiveX 控件、间谍软件(Spyware)等。



根据恶意代码的传播特性，可以将恶意代码分为主动传播和被动传播两大类。



## 1.2、恶意代码攻击模型

恶意代码的作用机制基本相同。其作用过程可大概分为以下 6 个步骤：

1. 侵入系统。
2. 维持或提升已有的权限。
3. 隐蔽。
4. 潜伏。
5. 破坏。
6. 重复前面 5 步对新的目标实施攻击过程。

![image-20241030131828104](https://cdn.jsdelivr.net/gh/xmtxsec/picture/imgl/202410301330522.png)



## 1.3、恶意代码生存技术

1. **反跟踪技术**：恶意代码靠采用反跟踪技术来提高自身的伪装能力和防破译能力，使检测与清除恶意代码的难度大大增加。
   - 反动态跟踪技术
     - 禁止跟踪中断。针对调试分析工具运行系统的单步中断与断点中断服务程序，恶意代码通过修改中断服务程序的入口地址来实现其反跟踪的目的。
     - 检测跟踪法。根据检测跟踪调试时和正常执行时的运行环境、中断入口和时间的不同，采取相应的措施实现其反跟踪目的。
     - 其他反跟踪技术。如指令流队列法和逆指令流法等。
   - 反静态分析技术
     - 对程序代码分块加密执行。为了不让程序代码通过反汇编进行静态分析，将分块的程序代码以密文形式装入内存，由解密程序在执行时进行译码，立即清除执行完毕后的代码，力求分析者在任何时候都无法从内存中获得执行代码的完整形式。
     - 伪指令法。伪指令法指将“废指令＂插入指令流中，让静态反汇编得不到全部正常的指令，进而不能进行有效的静态分析。伪指令技术还广泛应用于宏病毒与脚本恶意代码之中。
2. **加密技术**：加密技术是恶意代码进行自我保护的手段之一 ，再配合反跟踪技术的使用，让分析者不能正常调试和阅读恶意代码，无法获得恶意代码的工作原理，自然也不能抽取特征串。从加密的内容上划分，加密手段有三种，即信息加密、数据加密和程序代码加密。大部分恶意代码对程序体本身加密，但还有少数恶意代码对被感染的文件加密 。
3. **模糊变换技术**：恶意代码每感染一个客体对象时都会利用模糊变换技术使潜入宿主程序的代码不尽相同。
   - 指令替换技术：对恶意代码的 一进制代码进行反汇编，解码并计算指令长度再对其同义变换。
   - 指令压缩技术：经恶意代码反汇编后的全部指令由模糊变换器检测，对可压缩的指令同义压缩。压缩技术要想使病毒体代码的长度发生改变，必须对病毒体内的跳转指令重定位。
   - 指令扩展技术：扩展技术是对汇编指令进行同义扩展，所有经过压缩技术变换的指令都能够使用扩展技术来进行逆变换。扩展技术也需要对恶意代码的长度进行改变，进行恶意代码中跳转指令的重定位。
   - 伪指令技术：伪指令技术主要是将无效指令插入恶意代码程序体。
   - 重编译技术：使用重编译技术的恶意代码中携带恶意代码的源码，要在自带编译器或者操作系统提供编译器的基础上进行重新编译，这种技术不仅实现了变形的目的，而且为跨平台的恶意代码的出现提供了条件。
4. **自动生产技术**：普通病毒能够利用“多态性发生器”编译成具有多态性的病毒。多态变换引擎能够让程序代码本身产生改变，但却可以保持原有功能。反恶意代码软件若只是采用基于特征的扫描技术，则无法检测和清除这种恶意代码。

5. **变形技术**：病毒设计者设计出具体同一功能不同特征码的恶意代码。这种变换恶意代码特征码的技术称为变形技术。
   - 重汇编技术：变形引擎对病毒体的二进制代码进行反汇编，解码每一条指令，并对指令进行同义变换。
   - 压缩技术：变形器检测病毒体反汇编后的全部指令，对可进行压缩的一段指令进行同义压缩。
   - 膨胀技术：压缩技术的逆变换就是对汇编指令同义膨胀。
   - 伪指令技术：伪指令技术主要是对病毒体插入废指令。
   - 重编译技术：病毒体携带病毒体的源码，需要自带编译器或者利用操作系统提供的编译器进行重新编译，这为跨平台的恶意代码的出现打下了基础。

6. **三线程技术**：恶意代码进程同时开启了三个线程，其中一个为负责远程控制工作的主线程，另外两个为用来监视线程负责检查恶意代码程序是否被删除或被停止自启动的监视线程和守护线程。

7. **进程注入技术**：恶意代码程序为了实现隐藏和启动的目的，把自身嵌入到自启动服务有关的进程中。

8. **通信隐藏技术**
   - 端口定制技术：新木马一般都有定制端口的功能。优点：木马检测工具的 一种检测方法就是检测缺省端口，定制端口可以避过此方法的检测。
   - 端口复用技术：利用系统网络打开的端口（如 25 和139 等）传送数据 。使用端口复用技术的木马在保证端口默认服务正常工作的条件下复用，具有很强的欺骗性，可欺骗防火墙等安全设备，可避过 IDS 和安全扫描系统等安全工具。
   - 通信加密技术：即将恶意代码的通信内容加密发送。通信加密技术胜在能够使得通信内容隐藏，但弊端是通信状态无法隐藏。
   - 隐蔽通道技术：能有效隐藏通信内容和通信状态。但恶意代码编写者需要耗费大量时间以便找寻隐蔽通道。

9. **内核级隐藏技术**
   - LKM 隐藏：LKM 是可加载内核模块，用来扩展 Linux 的内核功能。LKM 能够在不用重新编译内核的情况下把动态加载内存中。基于这个优点，LKM 技术经常使用在系统设备的驱动程序和Rootkit 中。LKM Rootkit 通过系统提供的接口加载到内核空间，将恶意程序转化成内核的某一部分，再通过 hook 系统调用的方式实现隐藏功能。
   - 内存映射隐藏：内存映射是指由一个文件到一块内存的映射。内存映射可以将硬盘上的内容映射至内存中，用户可以通过内存指令读写文件。使用内存映射避免了多次调用 I/O 操作的行为，减少了不必要的资源浪费。



## 1.4、恶意代码攻击技术

1. **进程注入技术**：将某些自启动服务相关的嵌入了恶意代码程序的可执行代码作为载体，实现自身隐藏和启动的目的。

2. **超级管理技术**：恶意代码采用超级管理技术对反恶意代码软件系统进行拒绝服务攻击，阻碍反恶意代码软件的正常运行。

3. **端口反向连接技术**：恶意代码使用端口反向连接技术使攻击的服务端（被控制端）主动连接客户端（控制端）端口。

4. **缓冲区溢出攻击技术**：恶意代码利用系统和网络服务的安全漏洞植入并且执行攻击代码，攻击代码以一定的权限运行有缓冲区溢出漏洞的程序来获得被攻击主机的控制权。缓冲区溢出攻击成为恶意代码从被动式传播转为主动式传播的主要途径之一。



## 1.5、恶意代码分析技术

1. **静态分析法**
   - 反恶意代码软件的检测和分析：反恶意代码软件检测恶意代码的方法有特征代码法、校验和法、行为监测法、软件模拟法等。根据恶意代码的信息去搜寻更多的资料，若该恶意代码的分析数据已被反恶意代码软件收录，那就可以直接利用它们的分析结果。
   - 字符串分析：字符串分析的目的是寻找文件中使用的 ASCII 或其他方法编码的连续字符串。一些有用的信息可以通过在恶意代码样本中搜寻字符串得到。
   - 脚本分析：恶意代码如果是用 JS 、Perl 或者 shell 脚本等脚本语言编写的，那么恶意代码本身就可能带有源代码。通过文本编辑器将脚本打开查看源代码。脚本分析能帮助分析者用较短时间识别出大量流行的脚本类型。
   - 静态反编译分析：对于携带解释器的恶意代码可以采用反编译工具查看源代码。源代码在编译时，代码会被编译器优化，组成部分被重写，使得程序更适合解释和执行。
   - 静态反汇编分析：有线性遍历和递归遍历两种方法。线性遍历算法从输入程序的入口点开始反汇编，简单地遍历程序的整个代码区，反汇编它所遇到的每一条指令。虽然方法简单，但存在不能够处理嵌入指令流中的数据的问题。递归遍历算法试图用反汇编出来的控制流指令来指导反汇编过程。恶意代码被反汇编后，就可用控制流分析来构造它的流程图，该图又可以被许多的数据流分析工具所使用。由于控制流程图是大多数静态分析的基础，所以不正确的流程图反过来会使整个静态分析过程得到错误的结果。

2. **动态分析方法**
   - 文件监测：恶意代码在传播和破坏的过程中需要依赖读写文件系统，但存在极少数恶意代码只是单纯依赖内存却没有与文件系统进行交互。恶意代码执行后，在目标主机上可能读写各文件，修改程序，添加文件，甚至把代码嵌入其他文件，因此对文件系统必须进行监测。FileMon 是常用的文件监测程序，另外还有文件完整性监测工具，如 Trip wire 、
     AIDE 等。
   - 进程监测：恶意代码要入侵甚至传播，必须有新的进程生成或盗用系统进程的合法权限，主机上所有被植入进程的细节都能为分析恶意代码提供重要参考信息。常用的进程监测工具是 Process Explorer。
   - 网络活动监测：恶意代码经历了从早期的单一传染形式到依赖网络传染的多种传染方式的变化，因此分析恶意代码还要监测恶意代码的网络行为。使用网络嗅探器检测恶意代码传播的内容，当恶意代码在网络上发送包时，嗅探器就会将它们捕获 。 
   - 注册表监测：恶意代码运行时一般要改变 Windows 操作系统的配置来改变 Windows 操作系统的行为，实现恶意代码自身的目的 。 常用的监测软件是Regmon。
   - 动态反汇编分析：在恶意代码的执行过程中对其进行监测和分析。其基本思想是将恶意代码运行的控制权交给动态调试工具。该监测过程从代码的入口点处开始，控制权在程序代码与调试工具之间来回传递，直到程序执行完为止。这种技术能得到正确的反汇编代码，但只能对程序中那些实际执行的部分有效。目前主要的动态反汇编分析方法有以下两种：
     - 同内存调试：这种方法使调试工具与被分析恶意代码程序加载到相同的地址空间里。该方法的优点是实现代价相对较低，控制权转交到调试工具或者从调试工具转回恶意代码程序的实现相对来说比较简单；缺点是需要改变被分析程序的地址。
     - 仿真调试：即虚拟调试。这种方法是让调试工具与分析的恶意代码程序处于不同的地址空间 ，可绕过很多传统动态反跟踪类技术 。 这种方法的优点是不用修改目标程序中的地址，但在进程间控制权的转移上要付出较高的代价。

![image-20241030140555959](https://cdn.jsdelivr.net/gh/xmtxsec/picture/imgl/202410301405080.png)



## 1.6、恶意代码防范策略

一方面组织管理上必须加强恶意代码的安全防范意识。另一方面，通过技术手段来实现恶意代码防御。

![image-20241030142026996](https://cdn.jsdelivr.net/gh/xmtxsec/picture/imgl/202410301420103.png)

# 2、计算机病毒分析与防护

## 2.1、计算机病毒概念于特性

计算机病毒是一组具有自我复制、传播能力的程序代码。它常依附在计算机的文件中，如可执行文件或 Word 文档等。高级的计算机病毒具有变种和进化能力，可以对付反病毒程序。

所有计算机病毒都具有以下四个基本特点：

1. 隐蔽性。计算机病毒附加在正常软件或文档中，例如可执行程序、电子邮件、Word文档等。
2. 传染性。计算机病毒的传染性是指计算机病毒可以进行自我复制，并把复制的病毒附加到无病毒的程序中，或者去替换磁盘引导区的记录，使得附加了病毒的程序或者磁盘变成了新的病毒源，又能进行病毒复制，重复原先的传染过程。没有传染性的程序就不是计算机病毒。
3. 潜伏性。计算机病毒感染正常的计算机之后，一般不会立即发作，而是等到触发条件满足时，才执行病毒的恶意功能，从而产生破坏作用。计算机病毒常见的触发条件是特定日期。
4. 破坏性。计算机病毒对系统的危害性程度，取决于病毒设计者的设计意图。有的仅仅是恶作剧，有的破坏系统数据。简而言之，病毒的破坏后果是不可知的。



## 2.2、计算机病毒组成与运行机制

计算机病毒由三部分组成：

1. 复制传染部件(replicator)：控制病毒向其他文件的传染；
2. 隐藏部件(concealer)：防止病毒被检测到；
3. 破坏部件(bomb)：当病毒符合激活条件后，执行破坏操作。

计算机病毒的生命周期主要有两个阶段：

1. 计算机病毒的复制传播阶段。这一阶段有可能持续一个星期到几年。
2. 计算机病毒的激活阶段。计算机病毒在该阶段开始逐渐或突然破坏系统。



## 2.3、计算机病毒常见类型与技术

1. 引导型病毒：通过感染计算机系统的引导区而控制系统，病毒将真实的引导区内容修改或替换，当病毒程序执行后，才启动操作系统。因此，感染引导型病毒的计算机系统看似正常运转，而实际上病毒已在系统中隐藏，等待时机传染和发作。引导型病毒通常都是内存驻留的。
2. 宏病毒(Macro Viruses)：指利用宏语言来实现的计算机病毒。宏病毒的出现改变了病毒的载体模式，以前病毒的载体主要是可执行文件，而现在文档或数据也可作为宏病毒的载体。微软规定宏代码保存在文档或数据文件的内部，这样一来就给宏病毒传播提供了方便。同时，宏病毒的出现也实现了病毒的跨平台传播，它能够感染任何运行 Office 的计算机。宏病毒已经出现在 Word 、Excel 、Access 、PowerPoint 、Project 、Lotus 、AutoCAD 和 Corel Draw 当中。宏病毒的触发用户打开一个被感染的文件并让宏程序执行，宏病毒将自身复制到全局模板，然后通过全局模板把宏病毒传染到新打开的文件。
3. 多态病毒(Polymorphic Viruses)：多态病毒每次感染新的对象后，通过更换加密算法，改变其存在形式。多态病毒有三个主要组成部分：杂乱的病毒体、解密例程(decryption routine)、变化引擎(mutation engine) 。在一个多态病毒中，变化引擎和病毒体都被加密。一旦用户执行被多态病毒感染过的程序，则解密例程首先获取计算机的控制权，然后将病毒体和变化引擎进行解密。接下来，解密例程把控制权转让给病毒，重新开始感染新的程序。此时，病毒进行自我复制以及变化引擎随机访问内存 (RAM) 。病毒调用变化引擎，随机产生能够解开新病毒的解密例程。病毒加密产生新的病毒体和变化引擎，病毒将解密例程连同新加密的病毒和变化引擎一起放到程序中。这样一来，不仅病毒体被加密过，而且病毒的解密例程也随着感染不同
   而变化。因此，多态病毒没有固定的特征、没有固定的加密例程，从而就能逃避基于静态特征的病毒扫描器的检测。
4. 隐蔽病毒(Stealth Viruses)：隐蔽病毒试图将自身的存在形式进行隐藏，使得操作系统和反病毒软件不能发现。隐蔽病
   毒使用的技术有许多，主要包括：
   - 隐藏文件的日期、时间的变化；
   - 隐藏文件大小的变化；
   - 病毒加密。



## 2.4、计算机病毒防范策略与技术

计算机病毒防范是一个动态的过程，应通过多种安全防护策略及技术才能有效地控制计算机病毒的破坏和传播。

1. 查找计算机病毒源：对计算机文件及磁盘引导区进行计算机病毒检测，以发现异常情况，确证计算机病毒的存在。

   - 比较法：用原始备份与被检测的引导扇区或被检测的文件进行比较，检查文件及系统区域参数是否出现完整性变化。

   - 搜索法：用每一种病毒体含有的特定字节串对被检测的对象进行扫描。

   - 特征字识别法：基于特征串扫描法发展起来的 一种新方法。特征字识别法只须从病毒体内抽取很少的几个关键特征字，组成特征字库。

   - 分析法：反病毒技术人员通过详细分析病毒代码，制定相应的反病毒措施。使用分析法的目的是确认被观察的磁盘引导区和程序中是否含有病毒，辨别病毒的类型、种类、结构，提取病毒的特征字节串或特征字，用于增添到病毒代码库供病毒扫描和识别程序用 。

2. 阻断计算机病毒传播途径：由于计算机病毒的危害性是不可预见的，因此切断计算机病毒的传播途径是关键防护措
   施。
   - 用户具有计算机病毒防范安全意识和安全操作习惯。
   - 消除计算机病毒载体。
   - 安全区域隔离。

3. 主动查杀计算机病毒
   - 定期对计算机系统进行病毒检测 。 定期检查主引导区、引导扇区、中断向量表、文件属性（字节长度、文件生成时间等）、模板文件和注册表等。
   - 安装防计算机病毒软件，建立多级病毒防护体系 。 在网关、服务器和客户机器端都要安装合适的防计算机病毒软件，同时，做到及时更新病毒库。

4. 计算机病毒应急响应和灾备
   - 备份。对计算机病毒容易侵害的文件、数据和系统进行备份，如对主引导区、引导扇区、FAT 表、根目录表等系统重要数据做备份。
   - 数据修复技术。对遭受计算机病毒破坏的磁盘、文件等进行修复。
   - 网络过滤技术。通过网络的安全配置，将遭受计算机病毒攻击的计算机或网段进行安全隔离。
   - 计算机病毒应急响应预案。制定受病毒攻击的计算机及网络方面的操作规程和应急处置方案。



## 2.5、计算机病毒防护方案





















































































</span>