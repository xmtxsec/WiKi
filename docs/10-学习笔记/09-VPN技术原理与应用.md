
# VPN概述

## VPN概念
VPN 即虚拟专用网，其基本技术原理是把需要经过公共网传递的报文 (packet) 加密处理后，再由公共网络发送到目的地。利用 VPN 技术能够在不可信任的公共网络上构建 条专用的安全通道，经过 VPN 传输的数据在公共网上具有保密性。

 虚拟指网络连接特性是逻辑的而不是物理的。 VPN 是通过密码算法、标识鉴别、 安全协议等相关的技术，在公共的物理网络上通过逻辑方式构造出来的安全网络。


## VPN安全功能

- 保密性服务 (Confidentiality) :防止传输的信息被监听；
- 完整性服务 (Integrity) :防止传输的信息被修改；
- 认证服务 (Authentication) ：提供用户和设备的访问认证，防止非法接入。  


## VPN发展
未来 VPN 产品的技术动向具有以下特点：

- VPN 客户端尽量简化，将出现“零客户端“安装模式；
- VPN 网关一体化，综合集成多种接入模式，融合多种安全机制和安全功能；
- VPN 产品可能演变成可信网络产品
- VPN 提供标准安全管理数据接口，能够纳入 SOC 中心进行管理控制。  


## VPN技术风险

- VPN 产品代码实现的安全缺陷
-  VPN 密码算法安全缺陷
- VPN 管理不当引发的安全缺陷


# VPN类型和实现技术

## VPN类型
按照 VPN TCP/IP 协议层的实现方式，可以将其分为链路层 VPN 网络层 VPN 、传输层 VPN 。

- 链路层 VPN 的实现方式有 ATM Frame Relay 、多协议标签交换 MPLS; 
- 网络层 VPN 的实现方式有受控路由过滤、隧道技术；
- 传输层 VPN 则通过 SSL 来实现。  


## 密码算法
VPN 的核心技术是密码算法， VPN 利用密码算法，对需要传递的信息进行加密变换。目前，除了国外的 DES、AES、IDE、RSA 等密码算法外，国产商用密码算法 SM1、SM4 分组密码算法、 SM3 杂凑算法等也都可应用到 VPN。


## 密钥管理
密钥的分发有两种方法：

1. 通过手工配置的方式；手工配置的方法虽然可靠，但是密钥更新速度慢，一般只适合简单网络。
2. 采用密钥交换协议动态分发。密钥交换协议则采用软件方式， 自动协商动态生成密钥，密钥可快速更新，可以显著提高 VPN 的安全性。

目前，主要的密钥交换与管理标准有 SKIP （互联网简单密钥管理协议）和 ISAK.MP/Oakley （互联网安全联盟和密钥管理协议）。


## 认证访问控制
VPN 连接中一般都包括两种形式的认证：

1. 用户身份认证。VPN 连接建立之前， VPN 服务器对请求建立连接的 VPN 客户机进行身份验证，核查其是否为合法的授权用户。如果使用双向验证，还需进行 VPN 客户机对 VPN 服务器的身份验证， 以防伪装的非法服务器提供虚假信息。
2. 数据完整性和合法性认证。VPN 除了进行用户认证外，还需要检查传输的信息是否来自可信源，并且确认在传输过程中信息是否经过篡改。  


## IPSec（重点）
在 TCP/IP 协议网络中，由于 IP 协议的安全脆弱性，IPSec 工作组研究提出根据 IP 的安全需求制定了相关的 IP 安全系列规范： 认证头 (Authentication Header, 简称 AH) 、封装安全有效负荷 (Encapsulatin Security Payload, 简称 ESP) 以及密钥交换协议。

1. IP AH 是一种安全协议，又称为认证头协议。其安全目的是保证 IP 包的完整性和提供数据源认证。
2. IP ESP 也是一种安全协议，其用途在于保证 IP 包的保密性，也包括了防止重放攻击的顺序号。
3. 密钥交换协议，用于生成和分发在ESP和AH中使用的密钥，IKE也对远程系统进行初始认证。

**IPSec VPN 的两种工作模式**

- 传输模式（透明模式）：不改变原有的 IP 包头，只保护 IP 包中的数据域，通常用于主机和主机之间。
- 隧道模式：创建新的 IP 包头，并把旧的 IP 包（指需做安全处理的 IP 包） 作为新的 IP 包数据。保护旧 IP 包的包头和数据域。


## SSL（重点）
SSL 是一种应用于传输层的安全协议，用于构建客户端和服务端之间的安全通道。 SSL 协议是介于应用层和 TCP 层（传输层）之间的安全通信协议。其主要目的在于两个应用层之间相互通信时，使被传送的信息具有保密性及可靠性。<br /> <br />SSL协议，包含握手协议、密码规格变更协议、报警协议和记录层协议。

- 握手协议用于身份鉴别和安全参数协商；
- 密码规格变更协议用于通知安全参数的变更；
- 报警协议用于关闭通知和对错误进行报警；
- 记录层协议用于传输数据的分段、压缩及解压缩、加密及解密、完整性校验等。  

SSL 协议提供三种安全通信服务

1. 保密性通信。握手协议产生秘密密钥后才开始加 、解密数据。数据的加、 解密使用对称式密码算法。
2. 点对点之间的身份认证。采用非对称式密码算法。
3. 可靠性通信。信息传送时包含信息完整性检查，使用有密钥保护的消息认证码 MAC。的采用安全杂凑函数。

SSL 记录协议的数据处理过程其步骤如下：

1. SSL 将数据分割成可管理的区块长度。
2. 选择是否要将已分割的数据压缩。
3. 加上消息认证码 (MAC)。
4. 将数据加密，生成即将发送的消息。
5. 接收端将收到的消息解密、验证、解压缩，再重组后传送至较高层（例如应用层）， 即完成接收。


## PPTP
PPTP 是一个点到点安全隧道协议。该协议的目标是给电话上网的用户提供 VPN 安全服务。 PPTP 是 PPP 协议的一种扩展，它提供了在 IP 网上构建安全通道机制，远程用户通过 PPTP 可以在客户机和 PPTP 服务器之间形成一条安全隧道，从而能够保证远程用户安全访问企业的内部网。  


## L2TP
L2TP 用于保护设置 L2TP-enabled 的客户端和服务器的通信。客户端要求安装 L2TP 软件， L2TP 采用专用的隧道协议，该协议运行在 UDP 1701 端口。


## 关于PPTP和L2TP的补充
PPTP 和 L2TP 都使用 PPP 协议对数据进行封装，然后添加附加包头用于数据在互联网络上的传输。尽管两个协议非常相似，但是仍存在以下几方面的不同:

1. PPTP 要求互联网络为 IP 网络。L2TP 只要求隧道媒介提供面向数据包的点对点的连接。
2. PPTP 只能在两端点间建立单一隧道。L2TP 支持在两端点间使用多隧道。
3. L2TP可以提供包头压缩。当压缩包头时，系统开销(overhead) 占用4个字节，而 PPTP 协议要占用6个字节。
4. L2TP 可以提供隧道验证，而 PPTP 则不支持隧道验证。


# VPN主要产品于技术指标

## VPN主要产品
 商业产品有 IPSec VPN 网关、 SSL VPN 网关，或者集成 IPSec SSL 安全功能的防火墙和路由器。<br />开源产品如 StrongSwan、OpenSwan、OpenSSL 。

目前， VPN 技术的主要产品特征如下：

1. IPSec VPN。IPSec VPN 产品的工作模式应支待隧道模式和传输模式（透明模式），其中隧道模式适用于主机和网关实现，传输模式是可选功能，仅适用于主机实现。
2. SSL VPN。SSL VPN 产品的工作模式分为客户端－服务端模式、网关－网关模式两种。


## VPN产品主要技术指标
**密码算法要求**<br />IPSec VPN 使用国家密码管理局批准的非对称密码算法、对称密码算法、密码杂凑算法和随机数生成算法，算法及使用方法如下：

- 非对称密码算法使用 1024 比特 RSA 算法或 256 比特 SM2 椭圆曲线密码算法，用于实体验证、数字签名和数字信封等。
- 对称密码算法使用 128 比特分组的 SMl 分组密码算法，用于密钥协商数据的加密保护和报文数据的加密保护。该算法的工作模式为 CBC 模式。
- 密码杂凑算法使用 SHA-1 算法或 SM3 密码杂凑算法，用于对称密钥生成和完整性校验。其中， SM3 算法的输出为 256 比特。
- 随机数生成算法生成的随机数应能通过《随机性检测规范》规定的检测。 

SSL VPN 算法及使用方法如下：

- 非对称密码算法包括 256 位群阶 ECC 椭圆曲线密码算法SM2、IBC 标识密码算法 SM9 和1024 位以上 RSA 算法。
- 分组密码算法为 SMl 算法，用于密钥协商数据的加密保护和报文数据的加密保护。该算法的工作模式为 CBC 模式。
- 密码杂凑算法包括 SM3 算法和 SHA-1 算法，用于密钥生成和完整性校验。

**VPN 产品功能要求**<br />IPSec VPN 的主要功能包括：随机数生成、密钥协商、安全报文封装、 NAT 穿越、身份鉴别。身份认证数据应支持数字证书或公私密钥对方式， IP 协议版本应支持 IPv4 协议或 IPv6 协议。<br /> SSL VPN 的主要功能包括：随机数生成、密钥协商、安全报文传输、身份鉴别、访问控制、 密钥更新、客户端主机安全检查。

**VPN 产品性能要求**<br />IPSec VPN 主要性能指标如下。

1. 加解密吞吐率，在 64 字节以太帧长和 1428 字节 (IPv6 1408 字节）以太帧长时， IPSec VPN 产品在丢包率为0的条件下内网口上达到的双向数据最大流量。
2. 加解密时延，在 64 字节以太帧长和 1428 字节 (IPv6 1408 字节）以太帧长时， IPSec VPN 产品在丢包率为0的条件下，一个明文数据流经加密变为密文，再由密文解密还原为明文所消耗的平均时间。
3. 加解密丢包率，在 64 字节以太帧长和 1428 字节 (IPv6 1408 字节）以太帧长时， IPSec VPN 产品内网口处于线速情况下，单位时间内错误或丢失的数据包占总发数据包数量的百分比。
4. 每秒新建连接数， IPSec VPN 产品在一秒钟的时间单位内能够建立隧道数目的最大值。 

SSL VPN 主要性能指标如下。

1. 最大并发用户数，同时在线用户的最大数目，此指标反映产品能够同时提供服务的最大用户数量。
2. 最大并发连接数，同时在线 SSL 连接的最大数目，此指标反映产品能够同时处理的最大 SSL 连接数量。 
3. 每秒新建连接数，每秒钟可以新建的最大 SSL 连接数目，此指标反映产品每秒能够接入新 SSL 连接的能力。
4. 吞吐率，在丢包率为0的条件下，服务端产品在内网口上达到的双向数据最大流量。


# VPN技术应用

## 远程安全访问
Access VPN 主要解决远程用户安全办公问题，远程办公用户既要能远程获取到企业内部网信息，又要能够保证用户和企业内网的安全远程用户利用 VPN 技术，通过拨号、 ISDN 等方式接入公司内部网。 Access VPN 般包含两部分，远程用户 VPN 客户端软件和 VPN 接入设备


## 构建内部安全专网
Intranet VPN 的用途就是通过公用网络，如因特网，把分散在不同地理区域的企业办公点的局域网安全互联起来，实现企业内部信息的安全共享和企业办公自动化。


## 外部网络安全互联
Extranet VPN 则是利用 VPN 技术，在公共通信基础设施（如因特网）上把合作伙伴的网络或主机安全接到企业内部网，以方便企业与合作伙伴共享信息和服务。 Extranet VPN 解决了企业外部机构接入安全和通信安全的问题，同时也降低了网络建设成本。
