
# 环境准备
攻击机：<br />kali：192.168.1.28<br />![image-20210913152247891.png](./assets/1655878852972-ad33532a-e408-4034-9ae6-97efa1e9b17c.png)

内网边缘机器：<br />Win7：192.168.1.8   10.10.10.2<br />![image-20210913144106204.png](./assets/1655878857983-7deeff99-b439-4189-b2cc-587debf59f88.png)

内网机器：<br />win XP：10.10.10.3<br />![image-20210913144131732.png](./assets/1655878862665-54c60a4a-eaee-4695-b391-93b2629b9610.png)


# NPS
下载地址：[https://github.com/ehang-io/nps](https://github.com/ehang-io/nps)

nps是一款轻量级、高性能、功能强大的**内网穿透**代理服务器。目前支持**tcp、udp流量转发**，可支持任何**tcp、udp**上层协议（访问内网网站、本地支付接口调试、ssh访问、远程桌面，内网dns解析等等……），此外还**支持内网http代理、内网socks5代理**、**p2p等**，并带有功能强大的web管理端。

1、安装服务端
```
./nps install
```
![image-20210914152412012.png](./assets/1655878873624-74f14fb2-9432-4d79-b4b4-a5356affabc3.png)

2、启动服务端
```
nps start
```
![image-20210914153204559.png](./assets/1655878879084-7717ee71-c6c1-4e60-8f57-f7121d2aa98f.png)

3、在浏览器通过8080端口访问<br />![image-20210914153250570.png](./assets/1655878882599-1c9324ea-8c60-47b6-92fc-f9b684a869ee.png)

输入默认用户名、密码admin、123登录，登录后可以看到默认客户端连接端口为8024，登录后的Web界面如图所示。<br />![image-20210914153337448.png](./assets/1655878887564-ac05c8d0-ee8d-4e5b-8d0d-0efe0c1b0bc7.png)

4、添加客户端，如图所示，配置唯一验证密钥，验证密钥在从客户端连接到服务端时使用，此处配置为“123456”，然后开启压缩和加密传输。<br />![image-20210914153813970.png](./assets/1655878910216-4b3f973f-0abf-4dc5-925a-07b94dc5da04.png)

5、最后在边界主机连接服务端
```
npc.exe  -server=192.168.1.28:8024 -vkey=123456
```
![image-20210914154536786.png](./assets/1655878951686-25415648-c512-4713-93b5-f70e41975cad.png)

可以在攻击机看到上线成功<br />![image-20210914154608285.png](./assets/1655878955574-e290c623-e523-455f-92f4-c4439ec28364.png)


## TCP隧道
客户端上线后便可以通过Web界面单击上线的客户端、查看选项、配置隧道，例如，若想访问内网主机的3389端口，则可通过TCP隧道将内网主机的3389端口映射到攻击机的1111端口，单击“新增”，配置目标“10.10.10.3:3389”，配置服务端口为“1111”，TCP隧道如图所示。<br />![image-20210914154759918.png](./assets/1655878960895-2da861b2-0c24-4a31-b7eb-adcf5dc054b9.png)

TCP隧道建立成功后，即可通过连接攻击机的1111端口来连接内网主机的远程桌面，在攻击机运行命令“rdesktop 192.168.1.7:1111”连接本地的1111端口，隧道的使用如图所示。
```
rdesktop 192.168.1.28:1111
```
![image-20210914155058302.png](./assets/1655878969653-3b0a709f-7d4d-476e-afb6-f246aac285a9.png)


## socks5代理
若想搭建HTTP代理或SOCKS代理，只需选择对应模式，填写服务端端口即可，以SOCKS为例，选择模式为“SOCKS代理”，如图所示，服务端端口为“1234”。<br />![image-20210914155330269.png](./assets/1655878975471-dd4cd8ba-19b4-4be0-94fb-29210671c494.png)

配置好SOCKS代理后，便可使用攻击机192.168.1.28的1234端口访问内网，配置代理服务器<br />![image-20210914155433657.png](./assets/1655878981650-0bef0e2c-1835-463d-80f1-6e68686c9676.png)
![image-20210914155442855.png](./assets/1655878985585-0232b088-425f-43cd-82c7-f8c1bc11c8a9.png)

配置proxychains代理链的配置文件vim /etc/proxychains4.conf，将代理设置成本机的1234端口：socks5 127.0.0.1 1234<br />![image-20210914155550198.png](./assets/1655878995129-779e3912-4bfb-4882-82a1-fdeac07939eb.png)
![image-20210914155631642.png](./assets/1655878996818-c6cae718-9f59-4415-9adb-933bd8a17993.png)

